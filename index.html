<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ø¨Ø³Ø§Ù… Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ø¬Ù…Ø±ÙƒÙŠ</title>

  <!-- PWA -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#16a34a">
  <link rel="icon" href="/icons/icon-192.png">

  <style>
    :root{
      --green:#16a34a; --green2:#22c55e; --ink:#0f172a; --muted:#64748b;
      --card:#ffffff; --bg:#f1f5f9; --accent:#2563eb;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:'Noto Kufi Arabic',system-ui,sans-serif;color:var(--ink)}
    .wrap{max-width:780px;margin:16px auto;padding:12px}

    /* Hero */
    .hero{
      background:linear-gradient(135deg,var(--green),var(--green2));
      color:#fff;border-radius:24px;padding:22px 18px;position:relative;
      box-shadow:0 10px 30px rgba(22,163,74,.18);
    }
    .brand{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand h1{margin:0;font-size:22px;line-height:1.35}
    .badge{
      background:#fff;border:2px solid #fff;color:#064e3b;
      width:64px;height:64px;display:grid;place-items:center;border-radius:18px;
      font-weight:800;font-size:22px
    }
    .phone{margin-top:6px;opacity:.95;font-size:14px}
    .nav{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 0}
    .nav a{background:#e2e8f0;color:#0f172a;text-decoration:none;padding:8px 12px;border-radius:10px;font-weight:700}

    /* Cards / buttons */
    .card{background:var(--card);border-radius:18px;padding:16px;margin-top:16px;
          box-shadow:0 8px 24px rgba(0,0,0,.06);border:1px solid #e5e7eb}
    .owner{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .owner small{color:var(--muted)}
    .owner input{padding:10px 12px;border:1px solid #cbd5e1;border-radius:10px}
    .btn{border:none;border-radius:12px;padding:10px 14px;font-weight:800;cursor:pointer}
    .btn-blue{background:var(--accent);color:#fff}
    .btn-gray{background:#e2e8f0;color:#0f172a}
    .btn-green{background:#16a34a;color:#fff}
    .btn-red{background:#ef4444;color:#fff}
    .owner-on{color:#065f46;font-weight:800}

    /* Calculator */
    label{display:block;font-weight:700;margin-bottom:6px}
    input[type="number"], input[type="text"], textarea, select{
      width:100%;padding:12px 14px;border:1px solid #cbd5e1;border-radius:12px;
      font-size:16px;background:#fff;outline:none
    }
    textarea{min-height:90px;resize:vertical}
    .group-title{margin:16px 0 8px;font-weight:700;color:#334155}
    .rates{display:flex;flex-direction:column;gap:12px}
    .pill{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:12px;border-radius:999px;border:2px solid #cbead9;
      background:#f0fdf4;cursor:pointer
    }
    .pill input{appearance:none;width:20px;height:20px;border:2px solid #84d1b0;border-radius:50%;margin:0}
    .pill.active{background:#14532d;color:#fff;border-color:#14532d}
    .pill.active input{border-color:#fff;box-shadow:inset 0 0 0 6px #fff;background:#fff}
    .hint{font-size:13px;color:#0f5132;opacity:.9}
    .result{
      border:2px dashed #cbd5e1;border-radius:18px;padding:18px;background:#f8fafc;margin-top:8px;text-align:center
    }
    .result .big{font-size:40px;font-weight:900;color:#065f46;letter-spacing:1px}
    .result .mini{margin-top:8px;color:var(--muted)}
    .actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:16px}

    /* List */
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .half{flex:1 1 280px}
    .badges{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
    .badge2{background:#eef2ff;border:1px solid #dbeafe;color:#1e3a8a;border-radius:999px;padding:4px 10px;font-size:12px}
    .badge2.green{background:#ecfdf5;border-color:#bbf7d0;color:#14532d}
    .price-item{border-top:1px dashed #e5e7eb;padding-top:12px;margin-top:12px}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}

    @media (max-width:420px){ .result .big{font-size:34px} }

    /* PWA install button */
    #installBtn{
      position:fixed; bottom:16px; inset-inline:16px; z-index:9999;
      background:#16a34a; color:#fff; border:none; border-radius:14px;
      padding:12px 16px; font-weight:900; display:none; box-shadow:0 8px 20px rgba(22,163,74,.25);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Ø±Ø£Ø³ Ø§Ù„ØµÙØ­Ø© -->
    <section class="hero">
      <div class="brand">
        <h1>Ø¨Ø³Ø§Ù… Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ø¬Ù…Ø±ÙƒÙŠ</h1>
        <div class="badge">ğŸ’¼</div>
      </div>
      <div class="phone">Ù„Ù„Ø§Ø³ØªÙØ³Ø§Ø± ÙˆØ®Ø¯Ù…Ø§Øª Ø§Ù„ØªØ®Ù„ÙŠØµ: <b>00967771997809</b></div>
      <div class="nav">
        <a href="#prices">ğŸ’² Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ø¹Ø§Ø±</a>
        <a href="#calc">ğŸ§® Ø§Ù„Ø­Ø§Ø³Ø¨Ø©</a>
      </div>
      <!-- Ø§Ø®ØªØµØ§Ø±Ø§Øª Ø³Ø±ÙŠØ¹Ø© (ØªØ¸Ù‡Ø± Ù„Ù„Ø¬Ù…ÙŠØ¹Ø› Ø§Ù„Ø­Ø°Ù Ù„Ù„Ù…Ø§Ù„Ùƒ ÙÙ‚Ø·) -->
      <div class="presets" id="presets"></div>
    </section>

    <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© -->
    <section class="card" id="admin">
      <div class="owner">
        <span>ğŸ”’ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø§Ù„Ùƒ:</span>
        <input id="pin" type="password" placeholder="PIN" />
        <button class="btn btn-blue" id="unlock">ÙØªØ­</button>
        <button class="btn btn-gray" id="lock">Ù‚ÙÙ„</button>
        <small id="state">Ø§Ù„Ø­Ø§Ù„Ø©: Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·</small>
      </div>

      <!-- Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¶Ø§ÙØ© Ø§Ø®ØªØµØ§Ø± ÙŠØ¯ÙˆÙŠ (ÙŠØ¸Ù‡Ø± Ø¨Ø¹Ø¯ Ø§Ù„ÙØªØ­) -->
      <div id="adminForm" style="display:none;margin-top:10px">
        <div class="owner" style="gap:10px">
          <input id="pName" placeholder="Ø§Ø³Ù… Ø§Ø®ØªØµØ§Ø±â€¦ Ù…Ø«Ø§Ù„: Ø±Ø³ÙˆÙ… ÙÙ„Ø§ØªØ±" />
          <input id="pVal" type="number" inputmode="decimal" placeholder="Ù‚ÙŠÙ…Ø© Ø¨Ø§Ù„Ø¯ÙˆÙ„Ø§Ø±â€¦ 2000" />
          <button class="btn btn-blue" id="addPreset">Ø¥Ø¶Ø§ÙØ©</button>
          <button class="btn btn-gray" id="clearPresets">ØªÙØ±ÙŠØº Ø§Ù„ÙƒÙ„</button>
        </div>
        <small class="owner-on">Ø§Ù„Ø§Ø®ØªØµØ§Ø±Ø§Øª ØªÙØ­ÙØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­ ÙˆÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ Ø£Ùˆ Ø­Ø°ÙÙ‡Ø§ Ù„Ø§Ø­Ù‚Ù‹Ø§.</small>
      </div>
    </section>

    <!-- Ø§Ù„Ø­Ø§Ø³Ø¨Ø© -->
    <section class="card" id="calc">
      <label for="usd">Ù‚ÙŠÙ…Ø© Ø§Ù„Ø³Ù„Ø¹Ø© (Ø¨Ø§Ù„Ø¯ÙˆÙ„Ø§Ø± USD)</label>
      <input id="usd" type="number" inputmode="decimal" placeholder="Ù…Ø«Ø§Ù„: 2000" />

      <div class="group-title">Ø§Ø®ØªØ± Ø§Ù„ÙØ¦Ø© Ø§Ù„Ø¬Ù…Ø±ÙƒÙŠØ©</div>
      <div class="rates">
        <label class="pill" id="pill5">
          <div><b>5%</b> <span class="hint">(ÙØ¦Ø© Ø®Ù…Ø³Ø© Ø¨Ø§Ù„Ù…Ø¦Ø©)</span></div>
          <!-- 0.2075 = (0.25 Ù…Ø¹Ø§Ù…Ù„ Ã— 750 Ã— 5% / 750) Ù…Ø®ØªØµØ± Ø­Ø³Ø¨ Ù…Ø¹Ø§Ø¯Ù„ØªÙƒ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© -->
          <input type="radio" name="rate" value="0.2075" />
        </label>
        <label class="pill active" id="pill10">
          <div><b>10%</b> <span class="hint">(ÙØ¦Ø© Ø¹Ø´Ø±Ø© Ø¨Ø§Ù„Ù…Ø¦Ø©)</span></div>
          <input type="radio" name="rate" value="0.265" checked />
        </label>
      </div>

      <div class="group-title">Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¬Ù…Ø±ÙƒÙŠØ© (Ø±ÙŠØ§Ù„ ÙŠÙ…Ù†ÙŠ)</div>
      <div class="result">
        <div class="big" id="out">0</div>
        <div class="mini" id="formula">0 Ã— 750 Ã— 0 = 0</div>
      </div>

      <div class="actions">
        <button class="btn btn-blue"  onclick="window.print()">Ø·Ø¨Ø§Ø¹Ø© / Ø­ÙØ¸ PDF</button>
        <button class="btn btn-green" onclick="copyResult()">Ù†Ø³Ø® Ø§Ù„Ù†ØªÙŠØ¬Ø©</button>
        <button class="btn btn-green" onclick="shareWhatsApp()">Ù…Ø´Ø§Ø±ÙƒØ© ÙˆØ§ØªØ³Ø§Ø¨</button>
      </div>
    </section>

    <!-- Ø¥Ø¯Ø§Ø±Ø©/Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ø¹Ø§Ø± -->
    <section class="card" id="prices">
      <h3 style="margin-top:0">ğŸ’² Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ø¹Ø§Ø± (Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ / Ø­Ø°Ù)</h3>

      <div class="row">
        <div class="half">
          <label>Ø§Ø³Ù… Ø§Ù„Ø³Ù„Ø¹Ø©</label>
          <input id="itName" placeholder="Ù…Ø«Ø§Ù„: Ù…Ù„Ø§Ø¨Ø³ØŒ Ø¨Ø·Ø§Ø±ÙŠØ§Øªâ€¦" />
        </div>
        <div class="half">
          <label>Ø§Ù„Ø³Ø¹Ø± Ø¨Ø§Ù„Ø¯ÙˆÙ„Ø§Ø±</label>
          <input id="itPrice" type="number" inputmode="decimal" placeholder="Ù…Ø«Ø§Ù„: 3000" />
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div class="half">
          <label>Ø§Ù„ÙˆØ­Ø¯Ø©</label>
          <select id="itUnit">
            <option value="ton">Ø§Ù„Ø·Ù†</option>
            <option value="kg">Ø§Ù„ÙƒÙŠÙ„Ùˆ</option>
            <option value="dz">Ø§Ù„Ø¯ÙØ²Ù’Ù†</option>
            <option value="pcs">Ø§Ù„Ø­Ø¨Ø©</option>
            <option value="ltr">Ø§Ù„Ù„ØªØ±</option>
            <option value="Ah">Ah</option>
            <option value="W">W</option>
            <option value="yd">yd</option>
          </select>
        </div>
        <div class="half">
          <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§ÙƒØªØ¨ Ù‡Ù†Ø§ Ø§Ù„ÙØ¦Ø© Ù…Ø«Ù„: Ø§Ù„ÙØ¦Ø©5% Ø£Ùˆ Ø§Ù„ÙØ¦Ù‡ 10%)</label>
          <input id="itNotes" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„ÙØ¦Ø©5% â€¢ Ù…ØµØ¯Ø± Ø§Ù„Ø³Ø¹Ø± â€¢ ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ­Ø¯ÙŠØ«â€¦" />
        </div>
      </div>

      <div class="controls" style="margin-top:10px">
        <button class="btn btn-green" id="saveItem">Ø­ÙØ¸ / Ø­Ø¯Ù‘Ø«</button>
        <button class="btn btn-gray"  id="resetForm">ØªÙØ±ÙŠØº Ø§Ù„Ù†Ù…ÙˆØ°Ø¬</button>
        <input id="q" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…â€¦ Ù…Ø«Ø§Ù„: Ø¨Ø·Ø§Ø±ÙŠØ§ØªØŒ Ø´Ø¨ÙƒØŒ Ù…Ù„Ø§Ø¨Ø³" style="flex:1" />
        <button class="btn btn-blue" id="exportJson">ØªØµØ¯ÙŠØ± JSON</button>
        <button class="btn btn-blue" id="importJson">Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON</button>
      </div>

      <div id="list" style="margin-top:12px"></div>
    </section>
  </div>

  <!-- Ø²Ø± ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ -->
  <button id="installBtn">â¤µï¸ ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</button>

<script>
/* =================== PWA =================== */
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js').catch(()=>{});
}
let deferredPrompt=null;
const installBtn=document.getElementById('installBtn');
window.addEventListener('beforeinstallprompt',(e)=>{e.preventDefault();deferredPrompt=e;installBtn.style.display='block';});
installBtn.addEventListener('click',async()=>{if(!deferredPrompt)return;installBtn.style.display='none';deferredPrompt.prompt();await deferredPrompt.userChoice;deferredPrompt=null;});

/* =================== Ø§Ù„Ù…Ø§Ù„Ùƒ / Ø§Ù„Ø§Ø®ØªØµØ§Ø±Ø§Øª =================== */
const ADMIN_PIN="bassam1234";
const PRESETS_KEY='customQuickPresetsV2';
let isOwner=false;

const el=(id)=>document.getElementById(id);
const pin=el('pin'), unlock=el('unlock'), lockBtn=el('lock'), state=el('state');
const adminForm=el('adminForm'), pName=el('pName'), pVal=el('pVal');
const addPresetBtn=el('addPreset'), clearPresetsBtn=el('clearPresets'), presetsEl=el('presets');

function updateOwnerUI(){
  state.textContent='Ø§Ù„Ø­Ø§Ù„Ø©: '+(isOwner?'Ù…Ø§Ù„Ùƒ (ØªØ­Ø±ÙŠØ± Ù…ÙØ¹Ù‘Ù„)':'Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·');
  adminForm.style.display=isOwner?'':'none';
  renderPresets();
}
unlock.addEventListener('click',()=>{ if(pin.value===ADMIN_PIN){isOwner=true;updateOwnerUI();alert('âœ… ØªÙ… ÙØªØ­ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø§Ù„Ùƒ');}else alert('âŒ Ø±Ù…Ø² ØºÙŠØ± ØµØ­ÙŠØ­');});
lockBtn.addEventListener('click',()=>{ isOwner=false;updateOwnerUI(); });

function loadPresets(){ try{return JSON.parse(localStorage.getItem(PRESETS_KEY))||[]}catch{return[]} }
function savePresets(arr){ localStorage.setItem(PRESETS_KEY,JSON.stringify(arr)); }
function renderPresets(){
  const arr=loadPresets();
  presetsEl.innerHTML=arr.map(x=>(
    `<span class="badge2 green" onclick="fillValue(${x.value})">
      ${x.name}: ${x.value}$
      ${isOwner?`<b style="color:#b91c1c;cursor:pointer;margin-inline-start:6px" onclick="event.stopPropagation();delPreset(${JSON.stringify(x.name)})">Ã—</b>`:''}
    </span>`
  )).join('');
}
addPresetBtn?.addEventListener('click',()=>{
  if(!isOwner)return alert('Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ù„Ù…Ø§Ù„Ùƒ ÙÙ‚Ø·');
  const name=(pName.value||'').trim(); const val=parseFloat(pVal.value||0);
  if(!name||!val) return alert('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
  const arr=loadPresets(); const i=arr.findIndex(x=>x.name===name);
  if(i>=0) arr[i].value=val; else arr.push({name,value:val});
  savePresets(arr); pName.value=''; pVal.value=''; renderPresets();
});
clearPresetsBtn?.addEventListener('click',()=>{ if(!isOwner)return alert('Ù„Ù„Ù…Ø§Ù„Ùƒ ÙÙ‚Ø·'); if(confirm('Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø®ØªØµØ§Ø±Ø§ØªØŸ')){ savePresets([]); renderPresets(); }});
window.fillValue=(v)=>{ el('usd').value=v; calc(); window.location.hash='#calc'; window.scrollTo({top:0,behavior:'smooth'}); };
window.delPreset=(name)=>{ if(!isOwner)return; savePresets(loadPresets().filter(x=>x.name!==name)); renderPresets(); };

/* =================== Ø§Ù„Ø­Ø§Ø³Ø¨Ø© =================== */
const usdInput=el('usd'), outEl=el('out'), formulaEl=el('formula');
const rateRadios=Array.from(document.querySelectorAll('input[name="rate"]'));
const pills=[el('pill5'),el('pill10')];
const enFmt=new Intl.NumberFormat('en-US');

rateRadios.forEach((r,i)=>r.addEventListener('change',()=>{pills.forEach(p=>p.classList.remove('active')); if(pills[i])pills[i].classList.add('active'); calc();}));
usdInput.addEventListener('input',calc);

function getRate(){ const r=rateRadios.find(x=>x.checked); return r?parseFloat(r.value):0.265; }
function setRateByPercent(percent){ // 5 Ø£Ùˆ 10
  if(percent===5){ rateRadios[0].checked=true; pills[0].classList.add('active'); pills[1].classList.remove('active'); }
  else if(percent===10){ rateRadios[1].checked=true; pills[1].classList.add('active'); pills[0].classList.remove('active'); }
  calc();
}
function calc(){
  const v=parseFloat(usdInput.value||0), rate=getRate(), fx=750;
  const result=v*fx*rate;
  outEl.textContent=enFmt.format(Math.round(result));
  formulaEl.textContent=`${enFmt.format(v)} Ã— ${fx} Ã— ${rate} = ${enFmt.format(Math.round(result))}`;
}
function copyResult(){ const text=`Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¬Ù…Ø±ÙƒÙŠØ©: ${outEl.textContent} Ø±ÙŠØ§Ù„ ÙŠÙ…Ù†ÙŠ\n${formulaEl.textContent}`; navigator.clipboard.writeText(text).then(()=>alert('âœ” ØªÙ… Ø§Ù„Ù†Ø³Ø®')); }
function shareWhatsApp(){ const msg=`Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¬Ù…Ø±ÙƒÙŠØ©: ${outEl.textContent} Ø±ÙŠØ§Ù„ ÙŠÙ…Ù†ÙŠ\n${formulaEl.textContent}`; open('https://wa.me/?text='+encodeURIComponent(msg),'_blank'); }

/* =================== Ø§Ù„ÙƒØªØ§Ù„ÙˆØ¬ (Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„/Ø­Ø°Ù/Ø¨Ø­Ø«) =================== */
const CAT_KEY='pricesCatalogV3';
let catalog=[];
let editingIndex=null;

const itName=el('itName'), itPrice=el('itPrice'), itUnit=el('itUnit'), itNotes=el('itNotes');
const saveItem=el('saveItem'), resetForm=el('resetForm'), q=el('q'), list=el('list');
const exportBtn=el('exportJson'), importBtn=el('importJson');

function loadCatalog(){ try{ return JSON.parse(localStorage.getItem(CAT_KEY))||[] }catch{ return [] } }
function saveCatalog(arr){ localStorage.setItem(CAT_KEY, JSON.stringify(arr)); }
function arabicDigitsToEnglish(s){
  if(!s) return '';
  const map={'Ù ':'0','Ù¡':'1','Ù¢':'2','Ù£':'3','Ù¤':'4','Ù¥':'5','Ù¦':'6','Ù§':'7','Ù¨':'8','Ù©':'9'};
  return String(s).replace(/[Ù -Ù©]/g,d=>map[d]||d);
}
function parseRateFromNotes(notes){
  // ÙŠØ¨Ø­Ø« Ø¹Ù† 5% Ø£Ùˆ 10% Ø£Ùˆ ÙƒÙ„Ù…Ø© "Ø§Ù„ÙØ¦Ø© 5%"ØŒ Ø¨Ø£Ø±Ù‚Ø§Ù… Ø¹Ø±Ø¨ÙŠØ©/Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©
  const t=arabicDigitsToEnglish(notes||'').replace(/\s+/g,'');
  if(/(Ø§Ù„ÙØ¦Ø©|Ø§Ù„ÙØ¦Ù‡)?10%/.test(t) || /%?10/.test(t)) return 10;
  if(/(Ø§Ù„ÙØ¦Ø©|Ø§Ù„ÙØ¦Ù‡)?5%/.test(t)  || /%?5/.test(t))  return 5;
  return null;
}
function unitLabel(u){
  switch(u){
    case 'ton':return 'Ø§Ù„Ø·Ù†';
    case 'kg':return 'Ø§Ù„ÙƒÙŠÙ„Ùˆ';
    case 'dz':return 'Ø§Ù„Ø¯ÙØ²Ù’Ù†';
    case 'pcs':return 'Ø§Ù„Ø­Ø¨Ø©';
    case 'ltr':return 'Ø§Ù„Ù„ØªØ±';
    case 'Ah':return 'Ah';
    case 'W':return 'W';
    case 'yd':return 'yd';
    default:return u||'';
  }
}
function renderList(){
  const term=(q.value||'').trim();
  const items=catalog.filter(x=>!term || x.name.includes(term));
  list.innerHTML = items.map((x,idx)=>{
    const ratePct=parseRateFromNotes(x.notes);
    const rateBadge= ratePct ? `<span class="badge2 green">%${ratePct} Ø§Ù„ÙØ¦Ø©</span>` : '';
    return `
      <div class="price-item">
        <div style="font-weight:800">${x.name}</div>
        <div class="badges">
          <span class="badge2">${unitLabel(x.unit)}</span>
          ${rateBadge}
          <span class="badge2">USD ${x.price}</span>
        </div>
        ${x.notes?`<div style="margin-top:6px;color:#475569;font-size:13px">${x.notes}</div>`:''}
        <div class="controls">
          <button class="btn btn-green" onclick="usePrice(${idx})">Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø³Ø¹Ø±</button>
          <button class="btn btn-blue"  onclick="editItem(${idx})">ØªØ¹Ø¯ÙŠÙ„</button>
          <button class="btn btn-red"   onclick="delItem(${idx})">Ø­Ø°Ù</button>
        </div>
      </div>`;
  }).join('') || '<div style="color:#64748b">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ±.</div>';
}

function clearForm(){ editingIndex=null; itName.value=''; itPrice.value=''; itUnit.value='ton'; itNotes.value=''; saveItem.textContent='Ø­ÙØ¸ / Ø­Ø¯Ù‘Ø«'; }

function editItem(i){
  if(!isOwner) return alert('ÙØªØ­ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø§Ù„Ùƒ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„');
  const x=catalog[i]; if(!x) return;
  editingIndex=i;
  itName.value=x.name; itPrice.value=x.price; itUnit.value=x.unit; itNotes.value=x.notes||'';
  saveItem.textContent='ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†ØµØ±';
  window.location.hash='#prices';
}
function delItem(i){
  if(!isOwner) return alert('ÙØªØ­ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø§Ù„Ùƒ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ù„Ø­Ø°Ù');
  if(!confirm('ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¹Ø±ØŸ')) return;
  catalog.splice(i,1); saveCatalog(catalog); renderList();
}
function usePrice(i){
  const x=catalog[i]; if(!x) return;
  usdInput.value = x.price;
  const pct=parseRateFromNotes(x.notes);
  if(pct===5) setRateByPercent(5);
  else if(pct===10) setRateByPercent(10);
  calc();
  window.location.hash='#calc';
  window.scrollTo({top:0,behavior:'smooth'});
}

saveItem.addEventListener('click',()=>{
  if(!isOwner) return alert('ÙØªØ­ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø§Ù„Ùƒ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ù„Ø­ÙØ¸/Ø§Ù„ØªØ­Ø¯ÙŠØ«');
  const name=(itName.value||'').trim();
  const price=parseFloat(itPrice.value||0);
  const unit=itUnit.value||'pcs';
  const notes=itNotes.value||'';
  if(!name || !price) return alert('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø³Ø¹Ø±');
  const obj={name, price, unit, notes};
  if(editingIndex===null) catalog.push(obj);
  else catalog[editingIndex]=obj;
  saveCatalog(catalog); clearForm(); renderList();
});
resetForm.addEventListener('click', clearForm);
q.addEventListener('input', renderList);

exportBtn.addEventListener('click',()=>{
  const blob=new Blob([JSON.stringify(catalog,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='prices_catalog.json'; a.click();
  URL.revokeObjectURL(url);
});
importBtn.addEventListener('click',()=>{
  if(!isOwner) return alert('ÙØªØ­ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø§Ù„Ùƒ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯');
  const input=document.createElement('input'); input.type='file'; input.accept='application/json';
  input.onchange=()=>{ const f=input.files[0]; if(!f) return;
    const fr=new FileReader(); fr.onload=()=>{ try{
      const data=JSON.parse(fr.result);
      if(!Array.isArray(data)) throw new Error('ØµÙŠØºØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
      catalog=data.map(migrateItem);
      saveCatalog(catalog); renderList(); alert('âœ… ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯');
    }catch{ alert('ØµÙŠØºØ© JSON ØºÙŠØ± ØµØ§Ù„Ø­Ø©'); } };
    fr.readAsText(f);
  };
  input.click();
});

/* ØªØ±Ù‚ÙŠØ©/ØªÙˆØ­ÙŠØ¯ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© Ù…Ù† Ù…Ù„ÙØ§Øª Ù‚Ø¯ÙŠÙ…Ø© (Ø§Ù„ÙˆØ­Ø¯Ø©/Ø§Ù„Ø§Ø³Ù…/Ø§Ù„Ø³Ø¹Ø±/Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª) */
function migrateItem(x){
  const name = x.name || x['Ø§Ù„Ø§Ø³Ù…'] || x['Ø§Ø³Ù…'] || '';
  const notes= x.notes|| x['Ù…Ù„Ø­ÙˆØ¸Ø§Øª'] || x['Ù…Ù„Ø§Ø­Ø¸Ø§Øª'] || '';
  const price= parseFloat(x.price ?? x['Ø§Ù„Ø³Ø¹Ø±'] ?? 0) || 0;
  let unit = (x.unit || x['Ø§Ù„ÙˆØ­Ø¯Ø©'] || x['ÙˆØ­Ø¯Ø©'] || '').trim();
  // ØªÙˆØ­ÙŠØ¯ Ø¨Ø¹Ø¶ ÙˆØ­Ø¯Ø§Øª Ø¹Ø±Ø¨ÙŠØ© Ø¥Ù„Ù‰ Ù…ÙØ§ØªÙŠØ­Ù†Ø§
  const map = {'Ø·Ù†':'ton','Ø§Ù„ÙƒÙŠÙ„Ùˆ':'kg','ÙƒÙŠÙ„Ùˆ':'kg','dz':'dz','Ø§Ù„Ø¯Ø²Ù†':'dz','Ø§Ù„Ø¯ÙØ²Ù’Ù†':'dz',
               'Ø­Ø¨Ø©':'pcs','Ù‚Ø·Ø¹Ø©':'pcs','Ø§Ù„Ù„ØªØ±':'ltr','Ah':'Ah','W':'W','yd':'yd'};
  unit = map[unit] || unit || 'pcs';
  return {name, price, unit, notes};
}

/* ØªØ­Ù…ÙŠÙ„ Ø¨Ø¯Ø¦ÙŠ Ù…Ù† Ù…Ù„Ù Ø¹Ø§Ù… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) Ø«Ù… Ù…Ù† Ø§Ù„Ù…Ø­Ù„ÙŠ */
async function bootCatalog(){
  catalog=loadCatalog();
  if(!catalog.length){
    try{
      const res=await fetch('/json/prices_catalog.json',{cache:'no-store'});
      if(res.ok){
        const data=await res.json();
        if(Array.isArray(data)){ catalog=data.map(migrateItem); saveCatalog(catalog); }
      }
    }catch{}
  }
  renderList();
}

/* ØªØ´ØºÙŠÙ„ Ø£ÙˆÙ„ÙŠ */
(function init(){
  // Ø¯Ø¹Ù… ØªÙ…Ø±ÙŠØ± ?value= Ù…Ù† Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
  const params=new URLSearchParams(location.search);
  if(params.has('value')) usdInput.value=params.get('value');

  renderPresets();
  updateOwnerUI();
  calc();
  bootCatalog();
})();
</script>
</body>
</html>
