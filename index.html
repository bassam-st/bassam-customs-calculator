<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¬Ù…Ø±ÙƒÙŠØ©</title>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<style>
  body{font-family:'Noto Kufi Arabic',system-ui,sans-serif;background:#f1f5f9;margin:0}
  .top{background:#16a34a;color:#fff;padding:16px;text-align:center;font-weight:800}
  .wrap{max-width:880px;margin:16px auto;padding:0 12px}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.05);padding:14px;margin-top:12px}
  label{display:block;font-size:13px;color:#475569;margin:6px 0 4px}
  input{width:100%;padding:12px;border:1px solid #cbd5e1;border-radius:12px;font-size:16px;background:#fff}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .btn{border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
  .btn-green{background:#16a34a;color:#fff}
  .btn-gray{background:#e2e8f0}
  .res{font-size:40px;font-weight:800;color:#065f46;text-align:center}
  .muted{color:#64748b;font-size:12px}
  .pill{padding:10px;border-radius:999px;border:1px solid #cbd5e1;display:flex;align-items:center;gap:8px;justify-content:space-between}
  .pill.locked{opacity:.7;pointer-events:none}
  .row2{display:flex;gap:10px;flex-wrap:wrap}
  .nav a{display:inline-block;text-decoration:none;background:#e2e8f0;color:#0f172a;padding:8px 12px;border-radius:10px}
</style>
</head>
<body>
  <div class="top">ğŸ“¦ Ø¨Ø³Ù‘Ø§Ù… Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ø¬Ù…Ø±ÙƒÙŠ â€“ Ø§Ù„Ø­Ø§Ø³Ø¨Ø©</div>
  <div class="wrap">
    <div class="nav"><a href="./prices.html?v=3">â† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ø¹Ø§Ø±</a></div>

    <div class="card">
      <div class="row">
        <div>
          <label>Ø§Ø³Ù… Ø§Ù„Ø³Ù„Ø¹Ø©</label>
          <input id="name" placeholder="ÙŠÙÙ…Ù„Ø£ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¹Ù†Ø¯ Ø§Ù„Ù‚Ø¯ÙˆÙ… Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ø¹Ø§Ø±" />
        </div>
        <div>
          <label>Ø§Ù„ÙˆØ­Ø¯Ø©</label>
          <input id="unit" placeholder="Ù…Ø«Ø§Ù„: Ù„Ù„Ø­Ø¨Ø© / Ù„Ù„Ø·Ù†" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Ø§Ù„Ø³Ø¹Ø± Ù„Ù„ÙˆØ­Ø¯Ø© (USD)</label>
          <input id="unitPrice" type="number" inputmode="decimal" placeholder="Ù…Ø«Ø§Ù„: 15" />
        </div>
        <div>
          <label>Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙ„ÙŠ</label>
          <input id="qty" type="number" inputmode="numeric" placeholder="Ù…Ø«Ø§Ù„: 20" value="1" />
        </div>
      </div>

      <div>
        <label>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø³Ù„Ø¹Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ© (USD)</label>
        <input id="usdTotal" placeholder="ÙŠÙØ­Ø³Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ = Ø³Ø¹Ø± Ã— Ø¹Ø¯Ø¯ â€” ÙˆÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ÙƒØªØ§Ø¨Ø© ÙŠØ¯ÙˆÙŠÙ‹Ø§" />
      </div>

      <div class="row">
        <div>
          <label>Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù (Ø±ÙŠØ§Ù„/Ø¯ÙˆÙ„Ø§Ø±)</label>
          <input id="fx" type="number" inputmode="decimal" value="750" />
        </div>
        <div>
          <label>Ø§Ù„ÙØ¦Ø© Ø§Ù„Ø¬Ù…Ø±ÙƒÙŠØ©</label>
          <div id="rateBox" class="pill locked">
            <span id="rateLabel">â€”</span>
            <input id="rateValue" type="hidden" value="0" />
            <small class="muted">ØªÙØ­Ø¯Ù‘Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ø¹Ø§Ø± (Ù…Ù‚ÙÙˆÙ„Ø©)</small>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="res" id="out">0</div>
      <div class="muted" id="formula">0 = 0 Ã— 750 Ã— 0</div>
      <div class="row2" style="margin-top:10px">
        <button class="btn btn-green" onclick="copyResult()">Ù†Ø³Ø® Ø§Ù„Ù†ØªÙŠØ¬Ø©</button>
        <button class="btn btn-gray" onclick="shareWhatsApp()">Ù…Ø´Ø§Ø±ÙƒØ© ÙˆØ§ØªØ³Ø§Ø¨</button>
      </div>
    </div>
  </div>

<script>
  const $ = id => document.getElementById(id);
  const enFmt = new Intl.NumberFormat('en-US');
  function normalizeArabicDigits(s=""){
    const map = {'Ù ':'0','Ù¡':'1','Ù¢':'2','Ù£':'3','Ù¤':'4','Ù¥':'5','Ù¦':'6','Ù§':'7','Ù¨':'8','Ù©':'9'};
    return String(s).replace(/[Ù -Ù©]/g, d => map[d]);
  }
  function extractRate(text=""){
    const t = normalizeArabicDigits(text).replace(/\s/g,'');
    const m = t.match(/(\d{1,2})\s*%|(\d{1,2})\s*Ùª/);
    if (!m) return null;
    const num = parseInt((m[1]||m[2]),10);
    if (num===5) return 0.05;
    if (num===10) return 0.10;
    return null;
  }
  function setRateUIFromNumber(r){
    $('#rateValue').value = r || 0;
    $('#rateLabel').textContent = r ? (Math.round(r*100)+'%') : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©';
  }
  function formatYER(n){
    try { return new Intl.NumberFormat('ar-YE',{maximumFractionDigits:0}).format(Math.round(n)); }
    catch { return Math.round(n).toLocaleString(); }
  }
  function currentUSD(){
    const manual = parseFloat($('#usdTotal').value||'');
    if (!isNaN(manual) && manual>0) return manual;
    const up = parseFloat($('#unitPrice').value||'0') || 0;
    const q  = parseFloat($('#qty').value||'0') || 0;
    return up*q;
  }
  function calc(){
    const usd = currentUSD();
    const fx  = parseFloat($('#fx').value||'750') || 750;
    const rate= parseFloat($('#rateValue').value||'0') || 0;
    const duty = usd * fx * rate;
    $('#out').textContent = formatYER(duty);
    $('#formula').textContent = `${enFmt.format(Math.round(duty))} = ${rate} Ã— ${enFmt.format(fx)} Ã— ${enFmt.format(usd)}`;
  }
  ['unitPrice','qty','usdTotal','fx'].forEach(id => $('#'+id).addEventListener('input', calc));

  // Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ø¹Ø§Ø±
  const params = new URLSearchParams(location.search);
  const name  = params.get('name') || '';
  const unit  = params.get('unit') || '';
  const price = parseFloat(params.get('price')||'');
  const note  = params.get('note') || '';
  // rate Ù‚Ø¯ ØªØ£ØªÙŠ "5" Ø£Ùˆ "10" Ø£Ùˆ ÙØ§Ø±ØºØ©
  const rateP = params.get('rate');
  let rateNum = null;
  if (rateP) {
    const n = parseInt(normalizeArabicDigits(rateP),10);
    if (n===5) rateNum = 0.05;
    if (n===10) rateNum = 0.10;
  }
  if (rateNum===null) {
    const rFromNote = extractRate(note);
    if (rFromNote!==null) rateNum = rFromNote;
  }
  console.log('From prices:', {name, unit, price, note, rateP, rateNum});

  if (name) $('#name').value = name;
  if (unit) $('#unit').value = unit;
  if (!isNaN(price)) $('#unitPrice').value = price;
  setRateUIFromNumber(rateNum);

  calc();

  function copyResult(){
    const txt = `Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¬Ù…Ø±ÙƒÙŠØ©: ${$('#out').textContent} Ø±ÙŠØ§Ù„ ÙŠÙ…Ù†ÙŠ\n${$('#formula').textContent}`;
    navigator.clipboard.writeText(txt).then(()=>alert('âœ” ØªÙ… Ø§Ù„Ù†Ø³Ø®'));
  }
  function shareWhatsApp(){
    const msg = `Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¬Ù…Ø±ÙƒÙŠØ©: ${$('#out').textContent} Ø±ÙŠØ§Ù„ ÙŠÙ…Ù†ÙŠ\n${$('#formula').textContent}`;
    open('https://wa.me/?text='+encodeURIComponent(msg),'_blank');
  }
  window.copyResult = copyResult;
  window.shareWhatsApp = shareWhatsApp;
</script>
</body>
</html>
