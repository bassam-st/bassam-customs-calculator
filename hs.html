<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>البنود الجمركية – بحث عربي</title>
<style>
  body{font-family:'Noto Kufi Arabic',system-ui,sans-serif;background:#f1f5f9;margin:0}
  .top{background:#16a34a;color:#fff;padding:14px 16px;font-weight:800;font-size:18px;text-align:center}
  .wrap{max-width:880px;margin:16px auto;padding:0 12px}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.05);padding:14px;margin-top:12px}
  .muted{color:#64748b;font-size:12px}
  input{width:100%;padding:12px;border:1px solid #cbd5e1;border-radius:12px;font-size:16px;background:#fff}
  .item{display:flex;justify-content:space-between;gap:10px;padding:12px;border-bottom:1px dashed #e2e8f0;flex-wrap:wrap}
  .code{font-weight:800;color:#065f46}
  .name{font-weight:700}
  .desc{color:#475569;font-size:13px;margin-top:2px}
  .tag{display:inline-block;background:#dcfce7;border:1px solid #16a34a;color:#166534;border-radius:999px;padding:2px 8px;font-size:12px;margin-inline-start:8px}
  .btn{border:none;border-radius:10px;padding:8px 12px;font-weight:700;cursor:pointer}
  .btn-copy{background:#e2e8f0}
  .btn-go{background:#16a34a;color:#fff}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .nav a{display:inline-block;text-decoration:none;background:#e2e8f0;color:#0f172a;padding:8px 12px;border-radius:10px}
  mark{background:#fef08a}
</style>
</head>
<body>
  <div class="top">🔍 البحث في البنود الجمركية (يدعم العربية)</div>
  <div class="wrap">
    <div class="nav"><a href="./index.html">← العودة للحاسبة</a></div>

    <div class="card">
      <input id="q" placeholder="اكتب أول حرف… مثال: ب (بطاريات/بلاستيك)، م (ملابس/مسامير)…" autofocus />
      <div class="muted" style="margin-top:6px">يبدأ العرض من أول حرف – البحث يدعم إزالة التشكيل وتوحيد الأرقام.</div>
    </div>

    <div class="card" id="results">
      <div class="muted">جاري تحميل البيانات…</div>
    </div>
  </div>

<script>
  // — أدوات التطبيع —
  const rim=/[\u064B-\u065F\u0670\u06D6-\u06ED]/g;
  function normalizeArabic(s){
    if(!s) return "";
    return s.replace(/[\u0660-\u0669\u06F0-\u06F9]/g, d=> String("0123456789"["٠١٢٣٤٥٦٧٨٩".indexOf(d)]||d))
            .replace(rim,'')
            .replace(/[أإآا]/g,'ا').replace(/ى/g,'ي').replace(/ؤ/g,'و').replace(/ئ/g,'ي').replace(/ة/g,'ه')
            .replace(/[^\u0600-\u06FF0-9a-zA-Z\s\.]+/g,' ').replace(/\s+/g,' ').trim();
  }

  function highlight(text, q){
    if(!q) return text;
    const tn=normalizeArabic(text), qn=normalizeArabic(q);
    const i=tn.indexOf(qn); if(i<0) return text;
    // تقريب موضع الإبراز على النص الأصلي
    let oi=0, ni=0, start=-1, end=-1;
    while(oi<text.length && ni<=i){
      const seg=normalizeArabic(text[oi])||text[oi]; ni+=seg.length; oi++;
      if(ni>=i && start<0) start=oi-1;
    }
    while(oi<text.length && ni<i+qn.length){
      const seg=normalizeArabic(text[oi])||text[oi]; ni+=seg.length; oi++;
      if(ni>=i+qn.length){ end=oi; break; }
    }
    if(start>=0 && end>=0) return text.slice(0,start)+'<mark>'+text.slice(start,end)+'</mark>'+text.slice(end);
    return text;
  }

  const HS_URL='./assets/hs_catalog.json';
  let HS=[], HSn=[];

  async function loadHS(){
    try{
      HS = await fetch(HS_URL).then(r=>r.json());
      // فهرس مطبّع للاسم لتسريع البحث
      HSn = HS.map(x=>({ ...x, n: normalizeArabic(x.name||''), c: String(x.code||'') }));
      // عرض أولي لأعلى 200 بند (مرتبة أبجدياً)
      render(HSn.slice().sort((a,b)=>a.n.localeCompare(b.n)).slice(0,200), '');
    }catch(e){
      document.getElementById('results').innerHTML = '<div class="muted">تعذّر تحميل البيانات. تأكد من وجود الملف assets/hs_catalog.json</div>';
    }
  }

  function search(query){
    const q = normalizeArabic(query);
    if(!q) return HSn.slice().sort((a,b)=>a.n.localeCompare(b.n)).slice(0,200);
    const starts = [], contains = [];
    for(const x of HSn){
      if(x.n.startsWith(q) || x.c.startsWith(q)) starts.push(x);
      else if(x.n.includes(q)) contains.push(x);
    }
    // نُقدّم النتائج التي تبدأ بالاستعلام ثم الباقي — مع ترتيب أبجدي
    starts.sort((a,b)=>a.n.localeCompare(b.n));
    contains.sort((a,b)=>a.n.localeCompare(b.n));
    return starts.concat(contains);
  }

  function render(list, query){
    const box = document.getElementById('results');
    if(!list.length){ box.innerHTML='<div class="muted">لا نتائج… جرّب حرفًا آخر.</div>'; return; }
    box.innerHTML = list.slice(0,200).map(x=>{
      const nameHTML = highlight(x.name||'', query);
      const rateTag = x.rate ? `<span class="tag">فئة ${x.rate}</span>` : '';
      return `
        <div class="item">
          <div>
            <div class="name">${nameHTML} ${rateTag}</div>
            <div class="code">البند: ${x.code}</div>
          </div>
          <div class="row">
            <button class="btn btn-copy" onclick="navigator.clipboard.writeText('${x.code}').then(()=>alert('✔ نُسخ: ${x.code}'))">نسخ الكود</button>
            <button class="btn btn-go" onclick="location.href='./index.html?hs=${encodeURIComponent(x.code)}'">استخدام في الحاسبة</button>
          </div>
        </div>`;
    }).join('');
  }

  const q = document.getElementById('q');
  q.addEventListener('input', ()=>{ render(search(q.value), q.value); });

  loadHS();
</script>
</body>
</html>
