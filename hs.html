<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>البنود الجمركية – بحث عربي</title>
<style>
  body{font-family:'Noto Kufi Arabic',system-ui,sans-serif;background:#f1f5f9;margin:0}
  .top{background:#16a34a;color:#fff;padding:14px 16px;font-weight:800;font-size:18px;text-align:center}
  .wrap{max-width:880px;margin:16px auto;padding:0 12px}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.05);padding:14px;margin-top:12px}
  .muted{color:#64748b;font-size:12px}
  input{width:100%;padding:12px;border:1px solid #cbd5e1;border-radius:12px;font-size:16px;background:#fff}
  .item{display:flex;justify-content:space-between;gap:10px;padding:12px;border-bottom:1px dashed #e2e8f0;flex-wrap:wrap}
  .code{font-weight:800;color:#065f46}
  .name{font-weight:700}
  .desc{color:#475569;font-size:13px;margin-top:2px}
  .tag{display:inline-block;background:#dcfce7;border:1px solid #16a34a;color:#166534;border-radius:999px;padding:2px 8px;font-size:12px;margin-inline-start:8px}
  .btn{border:none;border-radius:10px;padding:8px 12px;font-weight:700;cursor:pointer}
  .btn-copy{background:#e2e8f0}
  .btn-go{background:#16a34a;color:#fff}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .nav a{display:inline-block;text-decoration:none;background:#e2e8f0;color:#0f172a;padding:8px 12px;border-radius:10px}
  mark{background:#fef08a}
</style>
</head>
<body>
  <div class="top">🔍 البحث في البنود الجمركية (يدعم العربية)</div>
  <div class="wrap">
    <div class="nav"><a href="./index.html">← العودة للحاسبة</a></div>

    <div class="card">
      <input id="q" placeholder="اكتب اسم الصنف بالعربي… مثال: بطاريات، ملابس، رولات تغليف، قطع غيار" autofocus />
      <div class="muted" style="margin-top:6px">البحث يدعم العربية وإزالة التشكيل وتوحيد الأرقام (٠١٢٣… ↔ 0123)</div>
    </div>

    <div class="card" id="results">
      <div class="muted">ابدأ بالكتابة لعرض النتائج…</div>
    </div>
  </div>

<script>
  // أدوات لتوحيد الكتابة العربية
  const rim = /[\u064B-\u065F\u0670\u06D6-\u06ED]/g;
  const arNums = "٠١٢٣٤٥٦٧٨٩";
  const enNums = "0123456789";
  const mapDigits = {};
  for(let i=0;i<10;i++){ mapDigits[arNums[i]] = enNums[i]; }

  function normalizeArabic(s){
    if(!s) return "";
    s = s.replace(/[\u0660-\u0669\u06F0-\u06F9]/g, d => mapDigits[d] ?? d);
    s = s.replace(rim,'')
         .replace(/[أإآا]/g,'ا')
         .replace(/ى/g,'ي')
         .replace(/ؤ/g,'و')
         .replace(/ئ/g,'ي')
         .replace(/ة/g,'ه')
         .replace(/[^\u0600-\u06FF0-9a-zA-Z\s\.]+/g,' ')
         .replace(/\s+/g,' ')
         .trim();
    return s;
  }

  function highlight(text, query){
    if(!query) return text;
    const qn = normalizeArabic(query);
    const tn = normalizeArabic(text);
    const idx = tn.indexOf(qn);
    if(idx < 0) return text;
    let i=0, j=0, start=-1, end=-1;
    while(i < text.length && j < tn.length){
      const ch = text[i];
      const nn = normalizeArabic(ch);
      if(j === idx) start = i;
      if(nn) j += nn.length;
      i++;
      if(j === idx + qn.length){ end = i; break; }
    }
    if(start>=0 && end>=0){
      return text.slice(0,start) + '<mark>' + text.slice(start,end) + '</mark>' + text.slice(end);
    }
    return text;
  }

  // تحميل بيانات البنود
  const HS_URL = './assets/hs_catalog.json';
  let HS = [];

  async function loadHS(){
    try{ HS = await fetch(HS_URL).then(r=>r.json()); }
    catch(e){ HS = []; }
  }

  function matches(item, query){
    if(!query) return false;
    const q = normalizeArabic(query);
    const n = normalizeArabic(item.name||'');
    const d = normalizeArabic(item.description||'');
    const c = String(item.code||'');
    return n.includes(q) || d.includes(q) || c.startsWith(q);
  }

  function render(list, query){
    const box = document.getElementById('results');
    if(!list.length){
      box.innerHTML = '<div class="muted">لا نتائج. جرّب كلمة أخرى مثل: "ملابس" أو "بطاريات".</div>';
      return;
    }
    box.innerHTML = list.slice(0,200).map(x=>{
      const nameHTML = highlight(x.name||'', query);
      const descHTML = x.description ? ('<div class="desc">'+highlight(x.description, query)+'</div>') : '';
      const rateTag = x.rate ? `<span class="tag">فئة ${x.rate}</span>` : '';
      return `
        <div class="item">
          <div>
            <div class="name">${nameHTML} ${rateTag}</div>
            <div class="code">البند: ${x.code}</div>
            ${descHTML}
          </div>
          <div class="row">
            <button class="btn btn-copy" onclick="copyCode('${x.code}')">نسخ الكود</button>
            <button class="btn btn-go" onclick="goCalc('${encodeURIComponent(x.code)}')">استخدام في الحاسبة</button>
          </div>
        </div>
      `;
    }).join('');
  }

  function copyCode(code){
    navigator.clipboard?.writeText(code).then(()=>alert('✔ تم نسخ الكود: '+code));
  }

  function goCalc(code){
    location.href = './index.html?hs='+code;
  }

  const q = document.getElementById('q');
  q.addEventListener('input', ()=>{
    const query = q.value;
    const list = HS.filter(x=>matches(x, query));
    render(list, query);
  });

  (async function init(){
    await loadHS();
    const sp = new URLSearchParams(location.search);
    if(sp.get('q')){ q.value = sp.get('q'); }
    const list = HS.filter(x=>matches(x, q.value||''));
    render(list, q.value||'');
    q.focus();
  })();
</script>
</body>
</html>
