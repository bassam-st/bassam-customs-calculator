<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø¬Ù…Ø±ÙƒÙŠØ© â€“ Ø¨Ø­Ø« Ø¹Ø±Ø¨ÙŠ</title>

<!-- âœ… PWA (GitHub Pages safe) -->
<link rel="manifest" href="./manifest.webmanifest">
<meta name="theme-color" content="#16a34a">
<link rel="icon" href="./icons/icon-192.png">

<style>
  body{font-family:'Noto Kufi Arabic',system-ui,sans-serif;background:#f1f5f9;margin:0}
  .top{background:#16a34a;color:#fff;padding:14px 16px;font-weight:800;font-size:18px;text-align:center}
  .wrap{max-width:880px;margin:16px auto;padding:0 12px}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.05);padding:14px;margin-top:12px}
  .muted{color:#64748b;font-size:12px}
  input{width:100%;padding:12px;border:1px solid #cbd5e1;border-radius:12px;font-size:16px;background:#fff}
  .item{display:flex;justify-content:space-between;gap:10px;padding:12px;border-bottom:1px dashed #e2e8f0;flex-wrap:wrap}
  .code{font-weight:800;color:#065f46}
  .name{font-weight:700}
  .desc{color:#475569;font-size:13px;margin-top:2px}
  .tag{display:inline-block;background:#dcfce7;border:1px solid #16a34a;color:#166534;border-radius:999px;padding:2px 8px;font-size:12px;margin-inline-start:8px}
  .btn{border:none;border-radius:10px;padding:8px 12px;font-weight:700;cursor:pointer}
  .btn-copy{background:#e2e8f0}
  .btn-go{background:#16a34a;color:#fff}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .nav a{display:inline-block;text-decoration:none;background:#e2e8f0;color:#0f172a;padding:8px 12px;border-radius:10px}
  mark{background:#fef08a}
</style>

<!-- âœ… ØªØ³Ø¬ÙŠÙ„ Service Worker (GitHub Pages safe) -->
<script>
(function(){
  if(!('serviceWorker' in navigator)) return;
  navigator.serviceWorker.register('./sw.js').catch(()=>{});
})();
</script>
</head>

<body>
  <div class="top">ğŸ” Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø¬Ù…Ø±ÙƒÙŠØ© (ÙŠØ¯Ø¹Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©)</div>
  <div class="wrap">
    <div class="nav"><a href="./index.html">â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø­Ø§Ø³Ø¨Ø©</a></div>

    <div class="card">
      <input id="q" placeholder="Ø§ÙƒØªØ¨ Ø£ÙˆÙ„ Ø­Ø±Ùâ€¦ Ù…Ø«Ø§Ù„: Ø¨ (Ø¨Ø·Ø§Ø±ÙŠØ§Øª/Ø¨Ù„Ø§Ø³ØªÙŠÙƒ)ØŒ Ù… (Ù…Ù„Ø§Ø¨Ø³/Ù…Ø³Ø§Ù…ÙŠØ±)â€¦" autofocus />
      <div class="muted" style="margin-top:6px">ÙŠØ¨Ø¯Ø£ Ø§Ù„Ø¹Ø±Ø¶ Ù…Ù† Ø£ÙˆÙ„ Ø­Ø±Ù â€“ Ø§Ù„Ø¨Ø­Ø« ÙŠØ¯Ø¹Ù… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ´ÙƒÙŠÙ„ ÙˆØªÙˆØ­ÙŠØ¯ Ø§Ù„Ø£Ø±Ù‚Ø§Ù….</div>
    </div>

    <div class="card" id="results">
      <div class="muted">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øªâ€¦</div>
    </div>
  </div>

<script>
  // â€” Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ·Ø¨ÙŠØ¹ â€”
  const rim=/[\u064B-\u065F\u0670\u06D6-\u06ED]/g;
  function normalizeArabic(s){
    if(!s) return "";
    return s
      .replace(/[\u0660-\u0669\u06F0-\u06F9]/g, d=>{
        const ar="Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©";
        const idx=ar.indexOf(d);
        return idx>=0 ? String("0123456789"[idx]) : d;
      })
      .replace(rim,'')
      .replace(/[Ø£Ø¥Ø¢Ø§]/g,'Ø§').replace(/Ù‰/g,'ÙŠ').replace(/Ø¤/g,'Ùˆ').replace(/Ø¦/g,'ÙŠ').replace(/Ø©/g,'Ù‡')
      .replace(/[^\u0600-\u06FF0-9a-zA-Z\s\.]+/g,' ')
      .replace(/\s+/g,' ')
      .trim();
  }

  function highlight(text, q){
    if(!q) return text;
    const tn=normalizeArabic(text), qn=normalizeArabic(q);
    const i=tn.indexOf(qn); if(i<0) return text;

    // ØªÙ‚Ø±ÙŠØ¨ Ù…ÙˆØ¶Ø¹ Ø§Ù„Ø¥Ø¨Ø±Ø§Ø² Ø¹Ù„Ù‰ Ø§Ù„Ù†Øµ Ø§Ù„Ø£ØµÙ„ÙŠ
    let oi=0, ni=0, start=-1, end=-1;
    while(oi<text.length && ni<=i){
      const seg=normalizeArabic(text[oi])||text[oi]; ni+=seg.length; oi++;
      if(ni>=i && start<0) start=oi-1;
    }
    while(oi<text.length && ni<i+qn.length){
      const seg=normalizeArabic(text[oi])||text[oi]; ni+=seg.length; oi++;
      if(ni>=i+qn.length){ end=oi; break; }
    }
    if(start>=0 && end>=0) return text.slice(0,start)+'<mark>'+text.slice(start,end)+'</mark>'+text.slice(end);
    return text;
  }

  const HS_URL='./assets/hs_catalog.json';
  let HS=[], HSn=[];

  async function loadHS(){
    try{
      const r = await fetch(HS_URL, {cache:'no-store'});
      HS = await r.json();
      HSn = HS.map(x=>({ ...x, n: normalizeArabic(x.name||''), c: String(x.code||'') }));
      render(HSn.slice().sort((a,b)=>a.n.localeCompare(b.n)).slice(0,200), '');
    }catch(e){
      document.getElementById('results').innerHTML =
        '<div class="muted">ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ù„Ù assets/hs_catalog.json</div>';
    }
  }

  function search(query){
    const q = normalizeArabic(query);
    if(!q) return HSn.slice().sort((a,b)=>a.n.localeCompare(b.n)).slice(0,200);

    const starts = [], contains = [];
    for(const x of HSn){
      if(x.n.startsWith(q) || x.c.startsWith(q)) starts.push(x);
      else if(x.n.includes(q)) contains.push(x);
    }
    starts.sort((a,b)=>a.n.localeCompare(b.n));
    contains.sort((a,b)=>a.n.localeCompare(b.n));
    return starts.concat(contains);
  }

  function render(list, query){
    const box = document.getElementById('results');
    if(!list.length){
      box.innerHTML='<div class="muted">Ù„Ø§ Ù†ØªØ§Ø¦Ø¬â€¦ Ø¬Ø±Ù‘Ø¨ Ø­Ø±ÙÙ‹Ø§ Ø¢Ø®Ø±.</div>';
      return;
    }
    box.innerHTML = list.slice(0,200).map(x=>{
      const nameHTML = highlight(x.name||'', query);
      const rateTag = x.rate ? `<span class="tag">ÙØ¦Ø© ${x.rate}</span>` : '';
      const codeSafe = String(x.code||'').replace(/'/g,"\\'");
      return `
        <div class="item">
          <div>
            <div class="name">${nameHTML} ${rateTag}</div>
            <div class="code">Ø§Ù„Ø¨Ù†Ø¯: ${codeSafe}</div>
          </div>
          <div class="row">
            <button class="btn btn-copy" onclick="navigator.clipboard.writeText('${codeSafe}').then(()=>alert('âœ” Ù†ÙØ³Ø®: ${codeSafe}'))">Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯</button>
            <button class="btn btn-go" onclick="location.href='./index.html?hs=${encodeURIComponent(codeSafe)}'">Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙÙŠ Ø§Ù„Ø­Ø§Ø³Ø¨Ø©</button>
          </div>
        </div>`;
    }).join('');
  }

  const q = document.getElementById('q');
  let ts=null;
  q.addEventListener('input', ()=>{
    clearTimeout(ts);
    ts=setTimeout(()=>{
      render(search(q.value), q.value);
      try{ window.trackSearch && window.trackSearch(q.value); }catch(_){}
    }, 400);
  });

  loadHS();
</script>

<!-- âœ… ØªØªØ¨Ù‘ÙØ¹ Inline -->
<script>
(function(){
  const TRACK_URL="https://bassam-tracker.onrender.com/track";
  function uuid(){return'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{
    const r=crypto.getRandomValues(new Uint8Array(1))[0]&15,v=c==='x'?r:(r&3|8);return v.toString(16);
  });}
  const LS=localStorage; let deviceId=LS.getItem("deviceId"); if(!deviceId){deviceId=uuid();LS.setItem("deviceId",deviceId);}
  async function send(event,payload){
    const body=JSON.stringify({event,deviceId,payload:payload||{}});
    try{
      if(navigator.sendBeacon){navigator.sendBeacon(TRACK_URL,new Blob([body],{type:"application/json"}));}
      else{await fetch(TRACK_URL,{method:"POST",headers:{"Content-Type":"application/json"},body});}
    }catch(_){}
  }
  document.addEventListener("DOMContentLoaded",()=>send("page_view",{path:location.pathname,title:document.title}));
  window.trackSearch=(q)=>send("search",{q:String(q||"").trim(),page:location.pathname});
})();
</script>
</body>
</html>
