<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø¬Ù…Ø±ÙƒÙŠØ© â€“ Ø¨Ø­Ø« Ø¹Ø±Ø¨ÙŠ</title>
<style>
  body{font-family:'Noto Kufi Arabic',system-ui,sans-serif;background:#f1f5f9;margin:0}
  .top{background:#16a34a;color:#fff;padding:14px 16px;font-weight:800;font-size:18px;text-align:center}
  .wrap{max-width:880px;margin:16px auto;padding:0 12px}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.05);padding:14px;margin-top:12px}
  .muted{color:#64748b;font-size:12px}
  input{width:100%;padding:12px;border:1px solid #cbd5e1;border-radius:12px;font-size:16px;background:#fff}
  .item{display:flex;justify-content:space-between;gap:10px;padding:12px;border-bottom:1px dashed #e2e8f0;flex-wrap:wrap}
  .code{font-weight:800;color:#065f46}
  .name{font-weight:700}
  .tag{display:inline-block;background:#dcfce7;border:1px solid #16a34a;color:#166534;border-radius:999px;padding:2px 8px;font-size:12px;margin-inline-start:8px}
  .btn{border:none;border-radius:10px;padding:8px 12px;font-weight:700;cursor:pointer}
  .btn-copy{background:#e2e8f0}
  .btn-go{background:#16a34a;color:#fff}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  mark{background:#fef08a}
</style>
<script>
if('serviceWorker'in navigator){navigator.serviceWorker.register('/sw.js').catch(()=>{});}
</script>
</head>
<body>
  <div class="top">ğŸ” Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø¬Ù…Ø±ÙƒÙŠØ© (ÙŠØªØ·Ù„Ù‘Ø¨ Ø§ØªØµØ§Ù„Ù‹Ø§ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª)</div>
  <div class="wrap">
    <div class="card">
      <input id="q" placeholder="Ø§ÙƒØªØ¨ Ø£ÙˆÙ„ Ø­Ø±Ùâ€¦ Ù…Ø«Ø§Ù„: Ø¨ ØŒ Ù… ØŒ Ø³â€¦" autofocus />
      <div class="muted" id="netHint">ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª Ù…ØªØµÙ„Ù‹Ø§ Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†ØªØ§Ø¦Ø¬.</div>
    </div>
    <div class="card" id="results"><div class="muted">Ø¬Ø§Ù‡Ø²â€¦</div></div>
  </div>

<script>
  const rim=/[\u064B-\u065F\u0670\u06D6-\u06ED]/g;
  function normalizeArabic(s){
    if(!s) return "";
    return s.replace(/[\u0660-\u0669\u06F0-\u06F9]/g, d=> String("0123456789"["Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©".indexOf(d)]||d))
            .replace(rim,'').replace(/[Ø£Ø¥Ø¢Ø§]/g,'Ø§').replace(/Ù‰/g,'ÙŠ').replace(/Ø¤/g,'Ùˆ').replace(/Ø¦/g,'ÙŠ').replace(/Ø©/g,'Ù‡')
            .replace(/[^\u0600-\u06FF0-9a-zA-Z\s\.]+/g,' ').replace(/\s+/g,' ').trim();
  }
  function highlight(text, q){
    if(!q) return text;
    const tn=normalizeArabic(text), qn=normalizeArabic(q);
    const i=tn.indexOf(qn); if(i<0) return text;
    return text.replace(new RegExp(q,'i'), m=>`<mark>${m}</mark>`);
  }

  const HS_URL='./assets/hs_catalog.json';
  let HS=[], HSn=[], ready=false;

  async function loadHSOnline(){
    if(!navigator.onLine){ ready=false; return; }
    const r = await fetch(HS_URL,{cache:'no-store'});
    HS = await r.json();
    HSn = HS.map(x=>({ ...x, n: normalizeArabic(x.name||''), c: String(x.code||'') }));
    ready=true;
  }

  function search(query){
    const q = normalizeArabic(query);
    if(!q) return [];
    const starts=[], contains=[];
    for(const x of HSn){
      if(x.n.startsWith(q) || x.c.startsWith(q)) starts.push(x);
      else if(x.n.includes(q)) contains.push(x);
    }
    starts.sort((a,b)=>a.n.localeCompare(b.n));
    contains.sort((a,b)=>a.n.localeCompare(b.n));
    return starts.concat(contains);
  }

  function render(list, query){
    const box=document.getElementById('results');
    if(!navigator.onLine){ box.innerHTML='<div class="muted">ğŸ“´ ØºÙŠØ± Ù…ØªØµÙ„ â€” Ø§Ù„Ø§ØªØµØ§Ù„ Ù…Ø·Ù„ÙˆØ¨ Ù„Ù„Ø¨Ø­Ø«.</div>'; return; }
    if(!ready){ box.innerHTML='<div class="muted">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øªâ€¦</div>'; return; }
    if(!list.length){ box.innerHTML='<div class="muted">Ù„Ø§ Ù†ØªØ§Ø¦Ø¬â€¦</div>'; return; }
    box.innerHTML=list.slice(0,200).map(x=>{
      const rateTag = x.rate ? `<span class="tag">ÙØ¦Ø© ${x.rate}</span>` : '';
      return `<div class="item">
        <div><div class="name">${highlight(x.name||'',query)} ${rateTag}</div><div class="code">Ø§Ù„Ø¨Ù†Ø¯: ${x.code}</div></div>
        <div class="row">
          <button class="btn btn-copy" onclick="navigator.clipboard.writeText('${x.code}').then(()=>alert('âœ” Ù†ÙØ³Ø®: ${x.code}'))">Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯</button>
          <button class="btn btn-go" onclick="location.href='./index.html?hs=${encodeURIComponent(x.code)}'">Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙÙŠ Ø§Ù„Ø­Ø§Ø³Ø¨Ø©</button>
        </div>
      </div>`;
    }).join('');
  }

  const q = document.getElementById('q');
  let ts=null;
  q.addEventListener('input', async ()=>{
    clearTimeout(ts);
    ts=setTimeout(async ()=>{
      if(!navigator.onLine){ render([], q.value); return; }
      if(!ready) await loadHSOnline();
      render(search(q.value), q.value);
      try{ window.trackSearch && window.trackSearch(q.value); }catch(_){}
    }, 350);
  });

  // Ø­Ø§Ù„Ø© Ø§Ù„Ø´Ø¨ÙƒØ©
  const netHint=document.getElementById('netHint');
  function updateNet(){
    netHint.textContent = navigator.onLine ? 'Ù…ØªØµÙ„ â€” Ø§ÙƒØªØ¨ Ù„Ù„Ø¨Ø­Ø«.' : 'ØºÙŠØ± Ù…ØªØµÙ„ â€” Ø§Ù„Ø§ØªØµØ§Ù„ Ù…Ø·Ù„ÙˆØ¨ Ù„Ù„Ø¨Ø­Ø«.';
    if(!navigator.onLine) ready=false;
  }
  window.addEventListener('online',  ()=>{ updateNet(); });
  window.addEventListener('offline', ()=>{ updateNet(); });
  updateNet();
</script>

<!-- ØªØªØ¨Ù‘Ø¹ -->
<script>
(function(){
  const URL="https://bassam-tracker.onrender.com/track";
  function uuid(){return'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{const r=crypto.getRandomValues(new Uint8Array(1))[0]&15,v=c==='x'?r:(r&3|8);return v.toString(16);});}
  const LS=localStorage;let id=LS.getItem("deviceId");if(!id){id=uuid();LS.setItem("deviceId",id);}
  function send(event,payload){const body=JSON.stringify({event,deviceId:id,payload:payload||{}});try{navigator.sendBeacon?navigator.sendBeacon(URL,new Blob([body],{type:"application/json"})):fetch(URL,{method:"POST",headers:{"Content-Type":"application/json"},body});}catch{}}
  document.addEventListener("DOMContentLoaded",()=>send("page_view",{path:location.pathname,title:document.title}));
  window.trackSearch=(q)=>send("search",{q:String(q||"").trim(),page:location.pathname});
})();
</script>
</body>
</html>
