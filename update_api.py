<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ø¹Ø§Ø± â€” Ø¨Ø³Ø§Ù… Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ø¬Ù…Ø±ÙƒÙŠ</title>
  <meta name="theme-color" content="#16a34a">
  <link rel="icon" href="/icons/icon-192.png">
  <style>
    :root{--green:#16a34a;--green2:#22c55e;--ink:#0f172a;--muted:#64748b;--card:#fff;--bg:#f1f5f9;--accent:#2563eb;--danger:#ef4444;--orange:#f97316}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);font-family:'Noto Kufi Arabic',system-ui,sans-serif;color:var(--ink)}
    .wrap{max-width:760px;margin:16px auto;padding:12px}
    .hero{background:linear-gradient(135deg,var(--green),var(--green2));color:#fff;border-radius:24px;padding:18px;box-shadow:0 10px 30px rgba(22,163,74,.18)}
    .hero h1{margin:0 0 6px 0;font-size:22px}
    .nav{display:flex;gap:8px;flex-wrap:wrap}
    .nav a{background:#e2e8f0;color:#0f172a;text-decoration:none;padding:8px 12px;border-radius:10px;font-weight:700}
    .card{background:var(--card);border-radius:18px;padding:14px;margin-top:14px;border:1px solid #e5e7eb;box-shadow:0 8px 24px rgba(0,0,0,.06)}
    .owner{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{border:none;border-radius:12px;padding:10px 14px;font-weight:800;cursor:pointer}
    .btn-blue{background:var(--accent);color:#fff} .btn-gray{background:#e2e8f0;color:#0f172a}
    .btn-green{background:#16a34a;color:#fff} .btn-red{background:var(--danger);color:#fff} .btn-orange{background:var(--orange);color:#fff}
    .owner input, .owner select{padding:10px 12px;border:1px solid #cbd5e1;border-radius:10px}
    .state{color:#065f46;font-weight:800}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .search{width:100%;padding:12px 14px;border:1px solid #cbd5e1;border-radius:12px}
    .item{border-top:1px dashed #e5e7eb;padding:12px 0}
    .head{display:flex;justify-content:space-between;align-items:center;gap:6px}
    .name{font-weight:900}
    .badges{display:flex;gap:6px;flex-wrap:wrap}
    .badge{background:#eef2ff;color:#334155;border:1px solid #c7d2fe;padding:4px 8px;border-radius:999px;font-size:12px}
    .badge.unit{background:#e2e8f0;border-color:#cbd5e1}
    .badge.rate5{background:#dcfce7;border-color:#bbf7d0;color:#166534}
    .badge.rate10{background:#fee2e2;border-color:#fecaca;color:#7f1d1d}
    .price{color:#0f172a;opacity:.9;font-size:13px;margin-top:4px}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .muted{color:#64748b;font-size:12px;margin-top:4px}
    .owner-only{display:none}
    .commit{min-width:200px}
  </style>
</head>
<body>
<div class="wrap">

  <section class="hero">
    <h1>ğŸ’² Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ø¹Ø§Ø±</h1>
    <div class="nav">
      <a href="./index.html">ğŸ  Ø§Ù„Ø­Ø§Ø³Ø¨Ø©</a>
      <a href="./hs.html">ğŸ” Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø¬Ù…Ø±ÙƒÙŠØ©</a>
    </div>
  </section>

  <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ù…Ø§Ù„Ùƒ -->
  <section class="card">
    <div class="owner">
      <span>ğŸ”’ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø§Ù„Ùƒ:</span>
      <input id="pin" type="password" placeholder="PIN">
      <button class="btn btn-blue" id="unlock">ÙØªØ­</button>
      <button class="btn btn-gray" id="lock">Ù‚ÙÙ„</button>
      <span class="state" id="state">Ø§Ù„Ø­Ø§Ù„Ø©: Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·</span>
    </div>

    <!-- Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ -->
    <div class="owner owner-only" style="gap:8px;margin-top:10px" id="formRow">
      <input id="fName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø³Ù„Ø¹Ø©" />
      <input id="fPrice" type="number" inputmode="decimal" placeholder="Ø§Ù„Ø³Ø¹Ø± Ø¨Ø§Ù„Ø¯ÙˆÙ„Ø§Ø±" />
      <select id="fUnit">
        <option value="ton">Ø§Ù„Ø·Ù†</option>
        <option value="kg">Ø§Ù„ÙƒÙŠÙ„Ùˆ</option>
        <option value="dz">Ø§Ù„Ø¯ÙØ²Ù’Ù†</option>
        <option value="pcs">Ø§Ù„Ø­Ø¨Ø©</option>
        <option value="ltr">Ø§Ù„Ù„ØªØ±</option>
        <option value="Ah">Ah/Ø£Ù…Ø¨ÙŠØ±</option>
        <option value="W">W/ÙˆØ§Ø·</option>
        <option value="yd">Ø§Ù„ÙŠØ§Ø±Ø¯Ø©</option>
        <option value="pair">Ø§Ù„Ø²ÙˆØ¬</option>
        <option value="bbl">Ø§Ù„Ø¨Ø±Ù…ÙŠÙ„</option>
        <option value="m2">Ø§Ù„Ù…ØªØ± Ø§Ù„Ù…Ø±Ø¨Ø¹</option>
        <option value="m3">Ø§Ù„Ù…ØªØ± Ø§Ù„Ù…ÙƒØ¹Ø¨</option>
        <option value="mg">Ù…Ù„ÙŠØ¬Ø±Ø§Ù…</option>
        <option value="g">Ø¬Ø±Ø§Ù…</option>
        <option value="roll">Ø§Ù„Ù„ÙØ©</option>
      </select>
      <input id="fNotes" style="min-width:180px" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ù…Ø«Ø§Ù„: Ø§Ù„ÙØ¦Ø©5%)" />
      <button class="btn btn-blue" id="saveBtn">Ø­ÙØ¸/ØªØ­Ø¯ÙŠØ«</button>
      <button class="btn btn-gray" id="clearBtn">ØªÙØ±ÙŠØº Ø§Ù„Ù†Ù…ÙˆØ°Ø¬</button>
    </div>
    <div class="muted">ğŸ’¡ Ù„Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ÙØ¦Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø§ÙƒØªØ¨ ÙÙŠ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª: <b>Ø§Ù„ÙØ¦Ø©5%</b> Ø£Ùˆ <b>Ø§Ù„ÙØ¦Ø©10%</b>.</div>
  </section>

  <!-- Ø£Ø¯ÙˆØ§Øª -->
  <section class="card">
    <input id="q" class="search" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…â€¦ Ù…Ø«Ø§Ù„: Ø¨Ø·Ø§Ø±ÙŠØ§ØªØŒ Ø´Ø¨ÙƒØŒ Ù…Ù„Ø§Ø¨Ø³">
    <div class="toolbar">
      <button class="btn btn-gray" id="exportBtn">ØªØµØ¯ÙŠØ± JSON</button>
      <input type="file" id="importFile" accept="application/json" style="display:none">
      <button class="btn btn-gray" id="importBtn">Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON</button>

      <!-- ğŸ†• Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø§Ù„Ùƒ Ù„Ù„Ø­ÙØ¸ Ø¥Ù„Ù‰ GitHub -->
      <input id="commitMsg" class="owner-only commit" placeholder="Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø­ÙØ¸ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
      <button id="pushBtn" class="btn btn-blue owner-only">ğŸ’¾ Ø­ÙØ¸ Ø¥Ù„Ù‰ GitHub</button>

      <small class="muted">Ø§Ù„Ù…ØµØ¯Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ: <code>assets/prices_catalog.json</code> (Ù…Ø¹ Ø¯Ù…Ø¬ Ø§Ù„Ù…Ø­Ù„ÙŠ).</small>
    </div>
  </section>

  <!-- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© -->
  <section class="card" id="list"></section>

</div>

<script>
/* ===== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø© ===== */
const ADMIN_PIN = "bassam1234";
const STORAGE_KEY = 'prices_catalog_v3';
const REMOTE_JSON = '/assets/prices_catalog.json';

let isOwner = false;
let ownerPin = null;
let items = [];
let editIndex = -1;

/* ===== DOM ===== */
const $ = id => document.getElementById(id);
const pin = $('pin'), unlock=$('unlock'), lockBtn=$('lock'), state=$('state');
const formRow = $('formRow'), fName=$('fName'), fPrice=$('fPrice'), fUnit=$('fUnit'), fNotes=$('fNotes');
const saveBtn=$('saveBtn'), clearBtn=$('clearBtn');
const list=$('list'), q=$('q');
const exportBtn=$('exportBtn'), importBtn=$('importBtn'), importFile=$('importFile');
const pushBtn=$('pushBtn'), commitMsg=$('commitMsg');

/* ===== ÙˆØ­Ø¯Ø§Øª ===== */
function unitMap(u){
  const s = String(u||'').toLowerCase();
  if (s.includes('Ø·Ù†') || s === 'ton') return 'ton';
  if (s.includes('ÙƒØ¬Ù…') || s.includes('ÙƒÙŠÙ„Ùˆ') || s === 'kg') return 'kg';
  if (s.includes('dz') || s.includes('Ø¯Ø±Ø²Ù†')) return 'dz';
  if (s.includes('Ù„ØªØ±') || s === 'ltr') return 'ltr';
  if (s.includes('ah') || s.includes('Ø£Ù…Ø¨ÙŠØ±')) return 'Ah';
  if (s.startsWith('w') || s.includes('ÙˆØ§Ø·')) return 'W';
  if (s === 'yd' || s.includes('ÙŠØ§Ø±Ø¯') || s.includes('ÙŠØ§Ø±Ø¯Ø©')) return 'yd';
  if (s === 'pair' || s.includes('Ø²ÙˆØ¬')) return 'pair';
  if (s === 'bbl' || s.includes('Ø¨Ø±Ù…ÙŠÙ„')) return 'bbl';
  if (s === 'm2' || s.includes('Ù…ØªØ± Ù…Ø±Ø¨Ø¹')) return 'm2';
  if (s === 'm3' || s.includes('Ù…ØªØ± Ù…ÙƒØ¹Ø¨')) return 'm3';
  if (s === 'mg' || s.includes('Ù…Ù„ÙŠØ¬Ø±Ø§Ù…')) return 'mg';
  if (s === 'g'  || s.includes('Ø¬Ø±Ø§Ù…')) return 'g';
  if (s === 'roll' || s.includes('Ù„ÙØ©') || s.includes('Ù„ÙÙ‡')) return 'roll';
  return 'pcs';
}
function unitLabel(u){
  switch(u){
    case 'ton': return 'Ø§Ù„Ø·Ù†';
    case 'kg' : return 'Ø§Ù„ÙƒÙŠÙ„Ùˆ';
    case 'dz' : return 'Ø§Ù„Ø¯ÙØ²Ù’Ù†';
    case 'pcs': return 'Ø§Ù„Ø­Ø¨Ø©';
    case 'ltr': return 'Ø§Ù„Ù„ØªØ±';
    case 'Ah' : return 'Ah/Ø£Ù…Ø¨ÙŠØ±';
    case 'W'  : return 'W/ÙˆØ§Ø·';
    case 'yd' : return 'Ø§Ù„ÙŠØ§Ø±Ø¯Ø©';
    case 'pair': return 'Ø§Ù„Ø²ÙˆØ¬';
    case 'bbl': return 'Ø§Ù„Ø¨Ø±Ù…ÙŠÙ„';
    case 'm2' : return 'Ø§Ù„Ù…ØªØ± Ø§Ù„Ù…Ø±Ø¨Ø¹';
    case 'm3' : return 'Ø§Ù„Ù…ØªØ± Ø§Ù„Ù…ÙƒØ¹Ø¨';
    case 'mg' : return 'Ù…Ù„ÙŠØ¬Ø±Ø§Ù…';
    case 'g'  : return 'Ø¬Ø±Ø§Ù…';
    case 'roll': return 'Ø§Ù„Ù„ÙØ©';
    default   : return u;
  }
}

/* ===== Ù…Ø¹Ø¯Ù„ Ø§Ù„ÙØ¦Ø© Ù…Ù† Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª ===== */
function parseRateFromNotes(notes){
  const s = String(notes||'').replace(/\s+/g,'');
  if (/Ø§Ù„ÙØ¦Ø©?10%|10%/.test(s)) return {pct:10, value:0.265, cls:'rate10'};
  if (/Ø§Ù„ÙØ¦Ø©?5%|5%/.test(s))  return {pct:5,  value:0.2075, cls:'rate5'};
  return {pct:10, value:0.265, cls:'rate10'};
}

/* ===== IO Ù…Ø­Ù„ÙŠ/Ø±ÙŠÙ…ÙˆØª ===== */
function normalize(rec){
  const name  = rec.name || rec['Ø§Ù„Ø§Ø³Ù…'] || rec['Ø§Ø³Ù…'] || '';
  const price = rec.price ?? rec['Ø§Ù„Ø³Ø¹Ø±'] ?? null;
  const unit  = rec.unit  || rec['Ø§Ù„ÙˆØ­Ø¯Ø©'] || rec['ÙˆØ­Ø¯Ø©'] || 'pcs';
  const notes = rec.notes || rec['Ù…Ù„Ø­ÙˆØ¸Ø§Øª'] || rec['Ù…Ù„Ø§Ø­Ø¸Ø§Øª'] || '';
  return { name: String(name).trim(), price: Number(price), unit: unitMap(unit), notes: String(notes).trim() };
}
function saveLocal(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(items)); }
function loadLocal(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY))||[] }catch{ return [] } }

async function boot(){
  let remote = [];
  try{
    const r = await fetch(REMOTE_JSON, {cache:'no-store'});
    if (r.ok){
      const raw = await r.json();
      remote = Array.isArray(raw) ? raw.map(normalize) : [];
    }
  }catch(e){}
  const local = loadLocal().map(normalize);
  const map = new Map();
  remote.forEach(x=>{ if(x.name) map.set(x.name,x); });
  local.forEach(x=>{ if(x.name) map.set(x.name,x); });
  items = Array.from(map.values());
  render();
}

/* ===== Ø¹Ø±Ø¶ ===== */
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

function render(){
  const term = (q.value||'').trim();
  const re = term ? new RegExp(term.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),'i') : null;

  const rows = items.map((it,i)=>{
    if (re && !re.test(it.name)) return null;
    const rate = parseRateFromNotes(it.notes);
    return `
      <div class="item">
        <div class="head">
          <div class="name">${escapeHtml(it.name)}</div>
          <div class="badges">
            <span class="badge unit">${unitLabel(it.unit)}</span>
            <span class="badge ${rate.cls}">%${rate.pct} Ø§Ù„ÙØ¦Ø©</span>
          </div>
        </div>
        <div class="price">USD ${it.price ?? ''}</div>
        ${it.notes ? `<div class="muted">${escapeHtml(it.notes)}</div>`:''}
        <div class="actions">
          <button class="btn btn-green" onclick="usePrice(${i})">Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø³Ø¹Ø±</button>
          <button class="btn btn-orange" onclick="editItem(${i})">ØªØ¹Ø¯ÙŠÙ„</button>
          <button class="btn btn-red" onclick="deleteItem(${i})">Ø­Ø°Ù</button>
        </div>
      </div>`;
  }).filter(Boolean).join('');

  list.innerHTML = rows || '<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± Ù…Ø·Ø§Ø¨Ù‚Ø©.</div>';
}

/* ===== Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø³Ø¹Ø± â†’ Ø§Ù„Ø­Ø§Ø³Ø¨Ø© ===== */
window.usePrice = function(idx){
  const it = items[idx]; if(!it) return;
  const rate = parseRateFromNotes(it.notes);
  const qty = 1;
  const url = `./index.html?price=${encodeURIComponent(it.price)}&qty=${qty}&ratePct=${rate.pct}`;
  location.href = url;
};

/* ===== ØªØ¹Ø¯ÙŠÙ„/Ø­Ø°Ù ===== */
window.editItem = function(idx){
  if(!isOwner) return alert('Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ù„Ù…Ø§Ù„Ùƒ ÙÙ‚Ø·');
  const it = items[idx]; if(!it) return;
  editIndex = idx;
  fName.value  = it.name;
  fPrice.value = it.price;
  fUnit.value  = it.unit;
  fNotes.value = it.notes || '';
  formRow.scrollIntoView({behavior:'smooth', block:'center'});
};
window.deleteItem = function(idx){
  if(!isOwner) return alert('Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ù„Ù…Ø§Ù„Ùƒ ÙÙ‚Ø·');
  const it = items[idx]; if(!it) return;
  if(confirm(`Ø³ÙŠØªÙ… Ø­Ø°Ù "${it.name}". Ù…ØªØ§Ø¨Ø¹Ø©ØŸ`)){
    items.splice(idx,1);
    saveLocal(); render();
  }
};

/* ===== Ø­ÙØ¸/ØªÙØ±ÙŠØº Ù…Ø­Ù„ÙŠ ===== */
saveBtn?.addEventListener('click', ()=>{
  if(!isOwner) return alert('Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ù„Ù…Ø§Ù„Ùƒ ÙÙ‚Ø·');
  const rec = normalize({name:fName.value, price:fPrice.value, unit:fUnit.value, notes:fNotes.value});
  if(!rec.name) return alert('Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø³Ù„Ø¹Ø©');
  if(!(rec.price>0)) return alert('Ø§ÙƒØªØ¨ Ø³Ø¹Ø±Ù‹Ø§ ØµØ­ÙŠØ­Ù‹Ø§ Ø¨Ø§Ù„Ø¯ÙˆÙ„Ø§Ø±');

  if(editIndex>=0){ items[editIndex] = rec; editIndex=-1; }
  else{
    const i = items.findIndex(x=>x.name===rec.name);
    if(i>=0) items[i] = rec; else items.push(rec);
  }
  saveLocal(); render();
  fName.value=''; fPrice.value=''; fNotes.value='';
});
clearBtn?.addEventListener('click', ()=>{ editIndex=-1; fName.value=''; fPrice.value=''; fNotes.value=''; });

/* ===== Ø¨Ø­Ø«/Ø§Ø³ØªÙŠØ±Ø§Ø¯/ØªØµØ¯ÙŠØ± (Ù…Ø­Ù…ÙŠ) ===== */
let ts=null;
q.addEventListener('input', ()=>{
  clearTimeout(ts);
  ts=setTimeout(()=>{
    render();
    try{ window.trackSearch && window.trackSearch(q.value); }catch(_){}
  }, 400);
});
q.addEventListener('keydown', (e)=>{ if(e.key === 'Enter'){ e.preventDefault(); } });

exportBtn.addEventListener('click', (e)=>{
  if(!isOwner){
    e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation?.();
    return alert('Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ù„Ù…Ø§Ù„Ùƒ ÙÙ‚Ø·');
  }
  const blob = new Blob([JSON.stringify(items, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = Object.assign(document.createElement('a'), {href:url, download:'prices_export.json'});
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});

importBtn.addEventListener('click', (e)=>{
  if(!isOwner){
    e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation?.();
    return alert('Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ù„Ù…Ø§Ù„Ùƒ ÙÙ‚Ø·');
  }
  importFile.click();
});
importFile.addEventListener('click', (e)=>{
  if(!isOwner){
    e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation?.();
    return false;
  }
}, true);
importFile.addEventListener('change', async (e)=>{
  if(!isOwner){
    e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation?.();
    e.target.value = '';
    return alert('Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ù„Ù…Ø§Ù„Ùƒ ÙÙ‚Ø·');
  }
  const file = e.target.files?.[0]; if(!file) return;
  try{
    const txt = await file.text();
    const arr = JSON.parse(txt);
    if(!Array.isArray(arr)) throw new Error('ØµÙŠØºØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
    items = arr.map(normalize);
    saveLocal(); render(); alert('âœ… ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­');
  }catch(err){ alert('âŒ ØªØ¹Ø°Ø± Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù: ' + err.message); }
  importFile.value = '';
});

/* ===== Ø­ÙØ¸ Ø¥Ù„Ù‰ GitHub Ø¹Ø¨Ø± /api/update ===== */
async function pushToGitHub(){
  if(!isOwner) return alert('Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ù„Ù…Ø§Ù„Ùƒ ÙÙ‚Ø·');
  if(!ownerPin){ return alert('Ø£Ø¹Ø¯ ÙØªØ­ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø§Ù„Ùƒ Ø£ÙˆÙ„Ù‹Ø§'); }
  const payload = {
    pin: ownerPin,
    items: items.map(normalize),
    message: (commitMsg.value || '').trim() || 'ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ù…Ù† Ø¯Ø§Ø®Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚'
  };
  try{
    const r = await fetch('/api/update', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const data = await r.json().catch(()=>({}));
    if(!r.ok){ throw new Error(data.detail || r.statusText); }
    alert('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¥Ù„Ù‰ GitHub Ø¨Ù†Ø¬Ø§Ø­');
  }catch(err){
    alert('âŒ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸ Ø¥Ù„Ù‰ GitHub: ' + err.message);
  }
}
pushBtn?.addEventListener('click', pushToGitHub);

/* ===== ÙØªØ­/Ù‚ÙÙ„ ===== */
function updateOwnerUI(){
  state.textContent = 'Ø§Ù„Ø­Ø§Ù„Ø©: ' + (isOwner ? 'Ù…Ø§Ù„Ùƒ (ØªØ­Ø±ÙŠØ± Ù…ÙØ¹Ù‘Ù„)' : 'Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·');
  formRow.classList.toggle('owner-only', !isOwner);
  [exportBtn, importBtn, pushBtn, commitMsg].forEach(el=>{
    if(!el) return;
    el.disabled = !isOwner;
    el.classList.toggle('owner-only', !isOwner);
    if(!isOwner){ el.value !== undefined && (el.value=''); }
  });
}
unlock.addEventListener('click', ()=>{
  if(pin.value === ADMIN_PIN){
    isOwner=true; ownerPin=pin.value; updateOwnerUI(); alert('âœ… ØªÙ… ÙØªØ­ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø§Ù„Ùƒ');
  } else alert('âŒ Ø±Ù…Ø² ØºÙŠØ± ØµØ­ÙŠØ­');
});
lockBtn.addEventListener('click', ()=>{ isOwner=false; ownerPin=null; updateOwnerUI(); });

/* ===== Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„ ===== */
updateOwnerUI();
boot();
</script>

<!-- ØªØªØ¨Ù‘ÙØ¹ Ø¨Ø³ÙŠØ· -->
<script>
(function(){
  const TRACK_URL="https://bassam-tracker.onrender.com/track";
  function uuid(){return'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{
    const r=crypto.getRandomValues(new Uint8Array(1))[0]&15,v=c==='x'?r:(r&3|8);return v.toString(16);
  });}
  const LS=localStorage; let deviceId=LS.getItem("deviceId"); if(!deviceId){deviceId=uuid();LS.setItem("deviceId",deviceId);}
  async function send(event,payload){
    const body=JSON.stringify({event,deviceId,payload:payload||{}});
    try{
      if(navigator.sendBeacon){navigator.sendBeacon(TRACK_URL,new Blob([body],{type:"application/json"}));}
      else{await fetch(TRACK_URL,{method:"POST",headers:{"Content-Type":"application/json"},body});}
    }catch(_){}
  }
  document.addEventListener("DOMContentLoaded",()=>send("page_view",{path:location.pathname,title:document.title}));
  window.trackSearch=(q)=>send("search",{q:String(q||"").trim(),page:location.pathname});
})();
</script>
</body>
</html>
