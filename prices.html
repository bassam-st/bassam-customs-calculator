<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ูุงุฆูุฉ ุงูุฃุณุนุงุฑ โ ุจุณุงู ูุณุงุนุฏู ุงูุฌูุฑูู</title>
  <meta name="theme-color" content="#16a34a">

  <!-- โ ุชุนุฏูู ููู: ูุณุงุฑ ุงูุฃููููุฉ ูููู ูุณุจู ุฏุงุฎู GitHub Pages -->
  <link rel="icon" href="./icons/icon-192.png">

  <style>
    :root{--green:#16a34a;--green2:#22c55e;--ink:#0f172a;--muted:#64748b;--card:#fff;--bg:#f1f5f9;--accent:#2563eb;--danger:#ef4444;--orange:#f97316}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);font-family:'Noto Kufi Arabic',system-ui,sans-serif;color:var(--ink)}
    .wrap{max-width:760px;margin:16px auto;padding:12px}
    .hero{background:linear-gradient(135deg,var(--green),var(--green2));color:#fff;border-radius:24px;padding:18px;box-shadow:0 10px 30px rgba(22,163,74,.18)}
    .hero h1{margin:0 0 6px 0;font-size:22px}
    .nav{display:flex;gap:8px;flex-wrap:wrap}
    .nav a{background:#e2e8f0;color:#0f172a;text-decoration:none;padding:8px 12px;border-radius:10px;font-weight:700}
    .card{background:var(--card);border-radius:18px;padding:14px;margin-top:14px;border:1px solid #e5e7eb;box-shadow:0 8px 24px rgba(0,0,0,.06)}
    .owner{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{border:none;border-radius:12px;padding:10px 14px;font-weight:800;cursor:pointer}
    .btn-blue{background:var(--accent);color:#fff} .btn-gray{background:#e2e8f0;color:#0f172a}
    .btn-green{background:#16a34a;color:#fff} .btn-red{background:var(--danger);color:#fff} .btn-orange{background:#f97316;color:#fff}
    .owner input, .owner select{padding:10px 12px;border:1px solid #cbd5e1;border-radius:10px}
    .state{color:#065f46;font-weight:800}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .search{width:100%;padding:12px 14px;border:1px solid #cbd5e1;border-radius:12px}
    .item{border-top:1px dashed #e5e7eb;padding:12px 0}
    .head{display:flex;justify-content:space-between;align-items:center;gap:6px}
    .name{font-weight:900}
    .badges{display:flex;gap:6px;flex-wrap:wrap}
    .badge{background:#eef2ff;color:#334155;border:1px solid #c7d2fe;padding:4px 8px;border-radius:999px;font-size:12px}
    .badge.unit{background:#e2e8f0;border-color:#cbd5e1}
    .badge.rate5{background:#dcfce7;border-color:#bbf7d0;color:#166534}
    .badge.rate10{background:#fee2e2;border-color:#fecaca;color:#7f1d1d}
    .price{color:#0f172a;opacity:.9;font-size:13px;margin-top:4px}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .muted{color:#64748b;font-size:12px;margin-top:4px}
    .owner-only{display:none}
    .commit{min-width:200px}

    /* ===== ุงูููุฏุงู ุงูุฐูู ุงูููุญูุฏ ===== */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;padding:16px;z-index:9999}
    .modal.show{display:flex}
    .backdrop{position:absolute;inset:0;background:rgba(0,0,0,.35)}
    .dialog{
      position:relative;background:#fff;border-radius:20px;border:1px solid #e5e7eb;
      max-width:480px;width:100%;padding:0;box-shadow:0 20px 60px rgba(0,0,0,.18);overflow:hidden
    }
    .dlg-head{
      background:linear-gradient(135deg,var(--green),var(--green2));color:#fff;
      padding:16px 18px;font-weight:900;display:flex;align-items:center;gap:10px
    }
    .dlg-body{padding:16px 18px}
    .dlg-foot{padding:14px 18px;display:flex;gap:8px;justify-content:flex-start;background:#f8fafc;border-top:1px solid #e5e7eb}
    .dlg-body label{display:block;font-weight:800;margin-bottom:6px}
    .dlg-body input, .dlg-body select{
      width:100%;padding:12px 14px;border:1px solid #cbd5e1;border-radius:12px;font-size:16px;margin-bottom:8px
    }
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .row > *{flex:1}
    .hint{color:#0f5132;background:#ecfdf5;border:1px solid #bbf7d0;border-radius:12px;padding:8px 10px;font-size:13px;margin:8px 0}
  </style>
</head>
<body>
<div class="wrap">

  <section class="hero">
    <h1>๐ฒ ูุงุฆูุฉ ุงูุฃุณุนุงุฑ</h1>
    <div class="nav">
      <a href="./index.html">๐ ุงูุญุงุณุจุฉ</a>
      <a href="./hs.html">๐ ุงูุจููุฏ ุงูุฌูุฑููุฉ</a>
    </div>
  </section>

  <!-- ุดุฑูุท ุงููุงูู -->
  <section class="card">
    <div class="owner">
      <span>๐ ูุถุน ุงููุงูู:</span>
      <input id="pin" type="password" placeholder="PIN">
      <button class="btn btn-blue" id="unlock">ูุชุญ</button>
      <button class="btn btn-gray" id="lock">ููู</button>
      <span class="state" id="state">ุงูุญุงูุฉ: ูุฑุงุกุฉ ููุท</span>
    </div>

    <!-- ูููุฐุฌ ุฅุถุงูุฉ/ุชุนุฏูู -->
    <div class="owner owner-only" style="gap:8px;margin-top:10px" id="formRow">
      <input id="fName" placeholder="ุงุณู ุงูุณูุนุฉ" />
      <input id="fPrice" type="number" inputmode="decimal" placeholder="ุงูุณุนุฑ ุจุงูุฏููุงุฑ" />
      <select id="fUnit">
        <option value="ton">ุงูุทู</option>
        <option value="kg">ุงููููู</option>
        <option value="dz">ุงูุฏูุฒูู</option>
        <option value="pcs">ุงูุญุจุฉ</option>
        <option value="pair">ุงูุฒูุฌ</option>
        <option value="roll">ุงูููุฉ</option>
        <option value="yd">ุงููุงุฑุฏุฉ</option>
        <option value="m">ุงููุชุฑ (ุทููู)</option>
        <option value="cm">ุงูุณูุชููุชุฑ</option>
        <option value="mm">ุงูููููุชุฑ</option>
        <option value="m2">ุงููุชุฑ ุงููุฑุจุน</option>
        <option value="m3">ุงููุชุฑ ุงูููุนุจ</option>
        <option value="ft">ุงููุฏู (ft)</option>
        <option value="in">ุงูุจูุตุฉ / ุงูุฅูุด</option>
        <option value="ltr">ุงููุชุฑ (L)</option>
        <option value="ml">ุงูููููุชุฑ (ml)</option>
        <option value="Ah">Ah/ุฃูุจูุฑ</option>
        <option value="W">W/ูุงุท</option>
        <option value="kW">kW/ูููููุงุท</option>
        <option value="kVA">kVA/ูููู ูุงุช</option><!-- โ ุฅุถุงูุฉ kVA -->
        <option value="bbl">ุงูุจุฑููู</option>
        <option value="mg">ูููุฌุฑุงู</option>
        <option value="g">ุฌุฑุงู</option>
      </select>
      <input id="fNotes" style="min-width:180px" placeholder="ููุงุญุธุงุช (ูุซุงู: ุงููุฆุฉ5%)" />
      <button class="btn btn-blue" id="saveBtn">ุญูุธ/ุชุญุฏูุซ</button>
      <button class="btn btn-gray" id="clearBtn">ุชูุฑูุบ ุงููููุฐุฌ</button>
    </div>
    <div class="muted">๐ก ูุงูุชูุงุท ุงููุฆุฉ ุชููุงุฆููุง ุงูุชุจ ูู ุงูููุงุญุธุงุช: <b>ุงููุฆุฉ5%</b> ุฃู <b>ุงููุฆุฉ10%</b>.</div>
  </section>

  <!-- ุฃุฏูุงุช -->
  <section class="card">
    <input id="q" class="search" placeholder="ุงุจุญุซ ุจุงูุงุณูโฆ ูุซุงู: ุจุทุงุฑูุงุชุ ุดุจูุ ููุงุจุณ">
    <div class="toolbar">
      <button class="btn btn-gray" id="exportBtn">ุชุตุฏูุฑ JSON</button>
      <input type="file" id="importFile" accept="application/json" style="display:none">
      <button class="btn btn-gray" id="importBtn">ุงุณุชูุฑุงุฏ JSON</button>
      <input id="commitMsg" class="owner-only commit" placeholder="ุฑุณุงูุฉ ุงูุญูุธ (ุงุฎุชูุงุฑู)">
      <button id="pushBtn" class="btn btn-blue owner-only">๐พ ุญูุธ ุฅูู GitHub</button>
      <small class="muted">ุงููุตุฏุฑ ุงูุฃุณุงุณู: <code>assets/prices_catalog.json</code> (ูุน ุฏูุฌ ุงููุญูู).</small>
    </div>
  </section>

  <!-- ุงููุงุฆูุฉ -->
  <section class="card" id="list"></section>

</div>

<!-- ===== ุงูููุฏุงู ุงูุฐูู ===== -->
<div class="modal" id="smartModal" role="dialog" aria-modal="true" aria-labelledby="dlgTitle">
  <div class="backdrop" onclick="closeSmartModal()"></div>
  <div class="dialog">
    <div class="dlg-head">
      <span id="dlgIcon" style="font-size:20px">๐งฎ</span>
      <div id="dlgTitle">ุงูุญุณุงุจ ุงูุณุฑูุน</div>
    </div>
    <div class="dlg-body" id="dlgBody"><!-- ุญููู ุฏููุงููููุฉ --></div>
    <div class="dlg-foot">
      <button class="btn btn-green" onclick="confirmSmartModal()">ูุชุงุจุนุฉ</button>
      <button class="btn btn-gray"  onclick="closeSmartModal()">ุฅูุบุงุก</button>
    </div>
  </div>
</div>

<script>
/* ===== ุฅุนุฏุงุฏุงุช ุนุงูุฉ ===== */
const ADMIN_PIN = "bassam1234";
const STORAGE_KEY = 'prices_catalog_v3';

/* โ ุชุนุฏูู ููู: ุฎูู ุงููุณุงุฑ ูุณุจู ุฏุงุฎู ูุดุฑูุน GitHub Pages */
const REMOTE_JSON = './assets/prices_catalog.json';

let isOwner = false;
let ownerPin = null;
let items = [];
let editIndex = -1;

// ุญุงูุฉ ุงูููุฏุงู
let _pendingIndex = null;
let _pendingKind  = null; // 'tv' | 'pcs' | 'dz' | 'yd' | 'roll' | 'kg' | 'ah' | 'w' | 'kw' | 'kva' | 'ltr' | 'ml' | 'other'

/* ===== DOM ===== */
const $ = id => document.getElementById(id);
const pin = $('pin'), unlock=$('unlock'), lockBtn=$('lock'), state=$('state');
const formRow = $('formRow'), fName=$('fName'), fPrice=$('fPrice'), fUnit=$('fUnit'), fNotes=$('fNotes');
const saveBtn=$('saveBtn'), clearBtn=$('clearBtn');
const list=$('list'), q=$('q');
const exportBtn=$('exportBtn'), importBtn=$('importBtn'), importFile=$('importFile');
const pushBtn=$('pushBtn'), commitMsg=$('commitMsg');

const smartModal=$('smartModal'), dlgBody=$('dlgBody'), dlgTitle=$('dlgTitle'), dlgIcon=$('dlgIcon');

/* ===== ูุญุฏุงุช & ูุฆุฉ ===== */
function unitMap(u){
  const s = String(u||'').toLowerCase();

  // ููุงุณุงุช ุนุงูุฉ
  if (s.includes('ุทู') || s === 'ton') return 'ton';
  if (s.includes('ูุฌู') || s.includes('ูููู') || s === 'kg') return 'kg';
  if (s.includes('dz') || s.includes('ุฏุฑุฒู') || s.includes('ุงูุฏุฒู') || s.includes('ุงูุฏูุฒู')) return 'dz';
  if (s.includes('ูุชุฑ') || s === 'ltr' || s === 'l' || s.includes('(l)')) return 'ltr';
  if (s.includes('ูู') && (s.includes('ูููุชุฑ') || s.includes('ููููุชุฑ') || s.includes('ูู ูุชุฑ') || s === 'ml')) return 'ml';
  if (s.includes('ah') || s.includes('ุฃูุจูุฑ')) return 'Ah';

  // ุทุงูุฉ/ูุฏุฑุฉ
  if (s === 'kva' || s.includes('ูููู') || s.includes('ูู ูู') || s.includes('ููุง') || s.includes('ู.ู.ุง') || s.includes('ู ู ุง') || s.includes('ูููู ูููุช') || s.includes('ูููููููุช')) return 'kVA';
  if (s === 'kw'  || s.includes('ูููููุงุท') || s.includes('ูููู ูุงุช')) return 'kW';
  if (s.startsWith('w') || s.includes('ูุงุท') || s.includes('ูุงุช')) return 'W';

  // ุฃุทูุงู ููุณุงุญุงุช ูุฃุญุฌุงู
  if (s === 'yd' || s.includes('ูุงุฑุฏ') || s.includes('ูุงุฑุฏุฉ')) return 'yd';
  if (s === 'm2' || s.includes('ูุชุฑ ูุฑุจุน')) return 'm2';
  if (s === 'm3' || s.includes('ูุชุฑ ููุนุจ')) return 'm3';
  if (s === 'm'  || (s.includes('ูุชุฑ') && !s.includes('ูุฑุจุน') && !s.includes('ููุนุจ'))) return 'm';
  if (s === 'cm' || s.includes('ุณูุชููุชุฑ') || s.includes('ุณู')) return 'cm';
  if (s === 'mm' || s.includes('ููููุชุฑ') || s.includes('ูู')) return 'mm';
  if (s === 'ft' || s.includes('ูุฏู')) return 'ft';
  if (s === 'in' || s.includes('ุจูุตู') || s.includes('ุจูุตุฉ') || s.includes('ุฅูุด') || s.includes('ุงูุด') || s.includes('ููุด')) return 'in';

  // ุฃุฎุฑู
  if (s === 'roll' || s.includes('ููุฉ') || s.includes('ููู')) return 'roll';
  if (s === 'pair' || s.includes('ุฒูุฌ')) return 'pair';
  if (s === 'bbl' || s.includes('ุจุฑููู')) return 'bbl';
  if (s === 'mg' || s.includes('ูููุฌุฑุงู') || s.includes('ููุบ')) return 'mg';
  if (s === 'g'  || s.includes('ุฌุฑุงู') || s.includes('ุบุฑุงู')) return 'g';

  // ุงูุชุฑุงุถู = ุญุจุฉ
  if (s.includes('ุญุจู') || s.includes('ุญุจุฉ') || s.includes('ูุทุนุฉ') || s === 'pcs') return 'pcs';
  return 'pcs';
}

function unitLabel(u){
  switch(u){
    case 'ton': return 'ุงูุทู';
    case 'kg' : return 'ุงููููู';
    case 'dz' : return 'ุงูุฏูุฒูู';
    case 'pcs': return 'ุงูุญุจุฉ';
    case 'pair':return 'ุงูุฒูุฌ';
    case 'roll':return 'ุงูููุฉ';
    case 'yd' : return 'ุงููุงุฑุฏุฉ';
    case 'm'  : return 'ุงููุชุฑ (ุทููู)';
    case 'cm' : return 'ุงูุณูุชููุชุฑ';
    case 'mm' : return 'ุงูููููุชุฑ';
    case 'm2' : return 'ุงููุชุฑ ุงููุฑุจุน';
    case 'm3' : return 'ุงููุชุฑ ุงูููุนุจ';
    case 'ft' : return 'ุงููุฏู (ft)';
    case 'in' : return 'ุงูุจูุตุฉ (in)';
    case 'ltr': return 'ุงููุชุฑ';
    case 'ml' : return 'ุงูููููุชุฑ';
    case 'Ah' : return 'Ah/ุฃูุจูุฑ';
    case 'W'  : return 'W/ูุงุท';
    case 'kW' : return 'kW/ูููููุงุท';
    case 'kVA': return 'kVA/ูููู ูุงุช'; /* โ */
    case 'bbl': return 'ุงูุจุฑููู';
    case 'mg' : return 'ูููุฌุฑุงู';
    case 'g'  : return 'ุฌุฑุงู';
    default   : return u;
  }
}

function parseRateFromNotes(notes){
  const s = String(notes||'').replace(/\s+/g,'');
  if (/ุงููุฆุฉ?10%|10%/i.test(s)) return {pct:10, value:0.265, cls:'rate10'};
  if (/ุงููุฆุฉ?5%|5%/i.test(s))  return {pct:5,  value:0.2075, cls:'rate5'};
  return {pct:10, value:0.265, cls:'rate10'};
}

/* ===== IO ูุญูู/ุฑูููุช ===== */
function normalize(rec){
  const name  = rec.name || rec['ุงูุงุณู'] || rec['ุงุณู'] || '';
  const price = rec.price ?? rec['ุงูุณุนุฑ'] ?? null;
  const unit  = rec.unit  || rec['ุงููุญุฏุฉ'] || rec['ูุญุฏุฉ'] || 'pcs';
  const notes = rec.notes || rec['ููุญูุธุงุช'] || rec['ููุงุญุธุงุช'] || '';
  return { name: String(name).trim(), price: Number(price), unit: unitMap(unit), notes: String(notes).trim() };
}
function saveLocal(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(items)); }
function loadLocal(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY))||[] }catch{ return [] } }

async function boot(){
  let remote = [];
  try{
    const r = await fetch(REMOTE_JSON, {cache:'no-store'});
    if (r.ok){
      const raw = await r.json();
      remote = Array.isArray(raw) ? raw.map(normalize) : [];
    }
  }catch(e){}
  const local = loadLocal().map(normalize);
  const map = new Map();
  remote.forEach(x=>{ if(x.name) map.set(x.name,x); });
  local.forEach(x=>{ if(x.name) map.set(x.name,x); });
  items = Array.from(map.values());
  render();
}

/* ===== ุนุฑุถ ุงููุงุฆูุฉ ===== */
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

function render(){
  const term = (q.value||'').trim();
  const re = term ? new RegExp(term.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),'i') : null;

  const rows = items.map((it,i)=>{
    if (re && !re.test(it.name)) return null;
    const rate = parseRateFromNotes(it.notes);
    return `
      <div class="item">
        <div class="head">
          <div class="name">${escapeHtml(it.name)}</div>
          <div class="badges">
            <span class="badge unit">${unitLabel(it.unit)}</span>
            <span class="badge ${rate.cls}">%${rate.pct} ุงููุฆุฉ</span>
          </div>
        </div>
        <div class="price">USD ${it.price ?? ''}</div>
        ${it.notes ? `<div class="muted">${escapeHtml(it.notes)}</div>`:''}
        <div class="actions">
          <button class="btn btn-green" onclick="usePrice(${i})">ุงุณุชุฎุฏุงู ุงูุณุนุฑ</button>
          <button class="btn btn-orange" onclick="editItem(${i})">ุชุนุฏูู</button>
          <button class="btn btn-red" onclick="deleteItem(${i})">ุญุฐู</button>
        </div>
      </div>`;
  }).filter(Boolean).join('');

  list.innerHTML = rows || '<div class="muted">ูุง ุชูุฌุฏ ุนูุงุตุฑ ูุทุงุจูุฉ.</div>';
}

/* ===== ูุดู ุงููุฆุงุช ุงูุฎุงุตุฉ ุจุงูุฃุณูุงุก ===== */
function isTVItem(it){
  const txt = (String(it.name||'') + ' ' + String(it.notes||'')).toLowerCase();
  return /ุชููุฒ|ุชููุฒููู|tv/.test(txt);
}

/* ===== ููุฏุงู ุฐูู ุฏููุงูููู ===== */
function openSmartModal(index, kind, title, icon, bodyHtml){
  _pendingIndex = index;
  _pendingKind  = kind;
  dlgTitle.textContent = title;
  dlgIcon.textContent  = icon || '๐งฎ';
  dlgBody.innerHTML    = bodyHtml;
  smartModal.classList.add('show');
  const firstInput = dlgBody.querySelector('input,select');
  setTimeout(()=>firstInput?.focus(), 30);
}
function closeSmartModal(){
  _pendingIndex = null;
  _pendingKind  = null;
  smartModal.classList.remove('show');
}

/* ===== ููุงูุจ ุงูุญููู ุญุณุจ ุงูููุน ===== */
function tmplTV(){
  return `
    <label>ูู ุจูุตุฉ ููุดุงุดุฉุ</label>
    <input id="tvInches" type="number" inputmode="decimal" placeholder="ูุซุงู: 32 ุฃู 43" />
    <div class="hint">ุฃูู ูู 40 ุจูุตุฉ = <b>3$</b>/ุจูุตุฉ โ 40+ = <b>4$</b>/ุจูุตุฉ. ุชูุฑุณู ุนูู ูุฆุฉ <b>5%</b>.</div>
  `;
}
function tmplPCS(){
  return `
    <label>ุงุฎุชุฑ ุทุฑููุฉ ุงูุญุณุงุจ</label>
    <select id="pcsMode">
      <option value="carton">ุจุญุณุจ ุงููุฑุชูู (ุนุฏุฏ ุงูุญุจุงุช ูู ุงููุฑุชูู)</option>
      <option value="direct">ุฃุญุณุจ ุจุงูุญุจุฉ ูุจุงุดุฑุฉ</option>
    </select>
    <div id="pcsCarton" class="row">
      <div>
        <label>ุนุฏุฏ ุงููุฑุงุชูู</label>
        <input id="pcsCartons" type="number" inputmode="numeric" placeholder="1" value="1" />
      </div>
      <div>
        <label>ุญุจุงุช/ูุฑุชูู</label>
        <input id="pcsPerCarton" type="number" inputmode="numeric" placeholder="ูุซุงู: 12" />
      </div>
    </div>
    <div id="pcsDirect" style="display:none">
      <label>ุนุฏุฏ ุงูุญุจุงุช</label>
      <input id="pcsCount" type="number" inputmode="numeric" placeholder="ูุซุงู: 24" />
    </div>
  `;
}
function tmplDZ(){
  return `
    <label>ุงุฎุชุฑ ุทุฑููุฉ ุงูุญุณุงุจ</label>
    <select id="dzMode">
      <option value="carton">ุจุญุณุจ ุงููุฑุชูู (ุนุฏุฏ ุงูุฏูุฒูู ูู ุงููุฑุชูู)</option>
      <option value="direct">ุฃุญุณุจ ุจุงูุญุจุฉ ูุจุงุดุฑุฉ (ุณุนุฑ ุงูุญุจุฉ = ุณุนุฑ ุงูุฏุฑุฒู รท 12)</option>
    </select>
    <div id="dzCarton" class="row">
      <div>
        <label>ุนุฏุฏ ุงููุฑุงุชูู</label>
        <input id="dzCartons" type="number" inputmode="numeric" value="1" />
      </div>
      <div>
        <label>ุฏูุฒูู/ูุฑุชูู</label>
        <input id="dzPerCarton" type="number" inputmode="numeric" placeholder="ูุซุงู: 10" />
      </div>
    </div>
    <div id="dzDirect" style="display:none">
      <div class="row">
        <div>
          <label>ุนุฏุฏ ุงูุญุจุงุช</label>
          <input id="dzPieces" type="number" inputmode="numeric" placeholder="ูุซุงู: 120" />
        </div>
        <div>
          <label>ุซุงุจุช ุงูุชุญููู</label>
          <input value="12" disabled />
        </div>
      </div>
      <div class="hint">ุณูุชู ุงุญุชุณุงุจ ุณุนุฑ ุงูุญุจุฉ ุชููุงุฆููุง: <b>ุณุนุฑ ุงูุฏุฑุฒู รท 12</b>.</div>
    </div>
  `;
}
function tmplYD(){
  return `
    <div class="row">
      <div>
        <label>ุนุฏุฏ ุงูููุงุช ูู ุงูุทุฑุฏ</label>
        <input id="rolls" type="number" inputmode="numeric" value="1" />
      </div>
      <div>
        <label>ูุงุฑุฏุฉ/ููุฉ</label>
        <input id="ydPerRoll" type="number" inputmode="decimal" placeholder="ูุซุงู: 50" />
      </div>
    </div>
    <div class="hint">ุงูุณุนุฑ ููุง ูููุงุฑุฏุฉ ุงููุงุญุฏุฉ. ุงูุฅุฌูุงูู = (ุงูููุงุช ร ูุงุฑุฏุฉ/ููุฉ ร ุณุนุฑ/ูุงุฑุฏุฉ).</div>
  `;
}
function tmplROLL(){
  return `
    <label>ุงุฎุชุฑ ุทุฑููุฉ ุงูุญุณุงุจ</label>
    <select id="rollMode">
      <option value="carton">ุจุญุณุจ ุงูุทุฑุฏ (ุนุฏุฏ ุงูููุงุช)</option>
      <option value="direct">ุฃุญุณุจ ุจุงูููุงุช ูุจุงุดุฑุฉ</option>
    </select>
    <div id="rollCarton">
      <label>ุนุฏุฏ ุงูููุงุช ูู ุงูุทุฑุฏ</label>
      <input id="rollsInCarton" type="number" inputmode="numeric" value="1" />
    </div>
    <div id="rollDirect" style="display:none">
      <label>ุนุฏุฏ ุงูููุงุช</label>
      <input id="rollCount" type="number" inputmode="numeric" placeholder="ูุซุงู: 5" />
    </div>
  `;
}
function tmplKG(){
  return `
    <label>ุงุฎุชุฑ ุทุฑููุฉ ุงูุญุณุงุจ</label>
    <select id="kgMode">
      <option value="carton">ุจุญุณุจ ุงููุฑุชูู (ูุฌู/ูุฑุชูู)</option>
      <option value="direct">ุฃุญุณุจ ุจุงููููู ูุจุงุดุฑุฉ</option>
    </select>
    <div id="kgCarton" class="row">
      <div>
        <label>ุนุฏุฏ ุงููุฑุงุชูู</label>
        <input id="kgCartons" type="number" inputmode="numeric" value="1" />
      </div>
      <div>
        <label>ูุฌู/ูุฑุชูู</label>
        <input id="kgPerCarton" type="number" inputmode="decimal" placeholder="ูุซุงู: 25" />
      </div>
    </div>
    <div id="kgDirect" style="display:none">
      <label>ุฅุฌูุงูู ุงูููููุงุช</label>
      <input id="kgTotal" type="number" inputmode="decimal" placeholder="ูุซุงู: 100" />
    </div>
  `;
}
function tmplScalar(kindLabel, unitSymbol){
  // Ah / W / kW / kVA / L / ml โฆ ุงูุณุนุฑ ูููุญุฏุฉ
  return `
    <label>ุงุฎุชุฑ ุทุฑููุฉ ุงูุฅุฏุฎุงู (${kindLabel})</label>
    <select id="scMode">
      <option value="total">ุฃุฏุฎู ุงูุฅุฌูุงูู (${unitSymbol})</option>
      <option value="perUnit">ุนุฏุฏ ุงููุทุน ร ${unitSymbol}/ูุทุนุฉ</option>
    </select>
    <div id="scTotal">
      <label>ุงูุฅุฌูุงูู (${unitSymbol})</label>
      <input id="scTotalVal" type="number" inputmode="decimal" placeholder="ูุซุงู: 1200" />
    </div>
    <div id="scPerUnit" class="row" style="display:none">
      <div>
        <label>ุนุฏุฏ ุงููุทุน</label>
        <input id="scCount" type="number" inputmode="numeric" placeholder="ูุซุงู: 10" />
      </div>
      <div>
        <label>${unitSymbol}/ูุทุนุฉ</label>
        <input id="scPer" type="number" inputmode="decimal" placeholder="ูุซุงู: 120" />
      </div>
    </div>
  `;
}

/* ===== ุงูุชุญ ุงูููุฏุงู ุงูููุงุณุจ ููุตูู ===== */
function openForItem(index){
  const it = items[index];
  const u  = unitMap(it.unit);

  // ุชููุฒููู ุญุณุจ ุงูุงุณู
  if (isTVItem(it)){
    openSmartModal(index, 'tv', 'ุงุญุณุจ ุณุนุฑ ุดุงุดุฉ ุงูุชููุฒููู', '๐บ', tmplTV());
    return;
  }

  switch(u){
    case 'pcs':
      openSmartModal(index, 'pcs', 'ุญุณุงุจ ุจุงูุญุจุฉ (PCS)', '๐ฆ', tmplPCS());
      bindToggle('pcsMode', 'pcsCarton', 'pcsDirect');
      break;
    case 'dz':
      openSmartModal(index, 'dz', 'ุญุณุงุจ ุจุงูุฏูุฒูู (DZ)', '๐งฎ', tmplDZ());
      bindToggle('dzMode', 'dzCarton', 'dzDirect');
      break;
    case 'yd':
      openSmartModal(index, 'yd', 'ุญุณุงุจ ุงูููุงุด ุจุงููุงุฑุฏุฉ (YD)', '๐งต', tmplYD());
      break;
    case 'roll':
      openSmartModal(index, 'roll', 'ุญุณุงุจ ุจุงูููุฉ (ROLL)', '๐งต', tmplROLL());
      bindToggle('rollMode', 'rollCarton', 'rollDirect');
      break;
    case 'kg':
      openSmartModal(index, 'kg', 'ุญุณุงุจ ุจุงููููู (KG)', 'โ๏ธ', tmplKG());
      bindToggle('kgMode', 'kgCarton', 'kgDirect');
      break;
    case 'Ah':
      openSmartModal(index, 'ah', 'ุญุณุงุจ ุจุงูุฃูุจูุฑ/ุณุงุนุฉ (Ah)', '๐', tmplScalar('Ah','Ah'));
      bindToggle('scMode', 'scTotal', 'scPerUnit');
      break;
    case 'W':
      openSmartModal(index, 'w', 'ุญุณุงุจ ุจุงููุงุท (W)', '๐ก', tmplScalar('W','W'));
      bindToggle('scMode', 'scTotal', 'scPerUnit');
      break;
    case 'kW':
      openSmartModal(index, 'kw', 'ุญุณุงุจ ุจุงููููููุงุท (kW)', 'โก', tmplScalar('kW','kW'));
      bindToggle('scMode', 'scTotal', 'scPerUnit');
      break;
    case 'kVA':
      openSmartModal(index, 'kva', 'ุญุณุงุจ ุจุงูู kVA (ูููู ูุงุช)', 'โก', tmplScalar('kVA','kVA'));
      bindToggle('scMode', 'scTotal', 'scPerUnit');
      break;
    case 'ltr':
      openSmartModal(index, 'ltr', 'ุญุณุงุจ ุจุงูููุชุฑ (L)', '๐ข๏ธ', tmplScalar('ูุชุฑ','L'));
      bindToggle('scMode', 'scTotal', 'scPerUnit');
      break;
    case 'ml':
      openSmartModal(index, 'ltr', 'ุญุณุงุจ ุจุงูููููุชุฑ (ml)', '๐งช', tmplScalar('ml','ml'));
      bindToggle('scMode', 'scTotal', 'scPerUnit');
      break;
    default:
      // ุงูุงูุชุฑุงุถู: ูููุฉ ุจุณูุทุฉ ูุจุงุดุฑุฉ ูุฃู ูุญุฏุฉ ุฃุฎุฑู
      openSmartModal(index, 'other', `ุญุณุงุจ ุณุฑูุน โ ${unitLabel(u)}`, '๐งฎ', `
        <label>ุงููููุฉ (${unitLabel(u)})</label>
        <input id="otherQty" type="number" inputmode="decimal" placeholder="ูุซุงู: 1" value="1" />
      `);
  }
}
function bindToggle(selId, onId, offId){
  const sel = document.getElementById(selId);
  const on  = document.getElementById(onId);
  const off = document.getElementById(offId);
  if (!sel||!on||!off) return;
  sel.addEventListener('change', ()=>{
    const mode = sel.value;
    if (mode==='carton' || mode==='total'){ on.style.display=''; off.style.display='none'; }
    else { on.style.display='none'; off.style.display=''; }
  });
}

/* ===== ุชุฃููุฏ ุงูููุฏุงู ูุญุณุงุจ ุงููุฌููุน ุจุงูุฏููุงุฑ ===== */
function confirmSmartModal(){
  const idx = _pendingIndex;
  if (idx==null) return;
  const it = items[idx];
  const u  = unitMap(it.unit);
  const rate = parseRateFromNotes(it.notes);
  let totalUSD = 0;

  function num(id){ const el = document.getElementById(id); return el? parseFloat(String(el.value||'').replace(',','.')) : NaN; }

  if (_pendingKind === 'tv'){
    const inches = num('tvInches');
    if (!(inches>0)) return alert('ุงูุชุจ ุนุฏุฏ ุงูุจูุตุงุช');
    const pricePerInch = inches < 40 ? 3 : 4;
    totalUSD = inches * pricePerInch;
    goToCalc(totalUSD, 1, 5); return;
  }

  if (_pendingKind === 'pcs'){
    const mode = (document.getElementById('pcsMode')||{}).value || 'carton';
    if (mode==='carton'){
      const cartons = num('pcsCartons') || 0;
      const per     = num('pcsPerCarton') || 0;
      if (!(cartons>0 && per>0)) return alert('ุฃุฏุฎู ุนุฏุฏ ุงููุฑุงุชูู ูุงูุญุจุงุช/ูุฑุชูู');
      totalUSD = (cartons * per) * it.price;
    } else {
      const count = num('pcsCount') || 0;
      if (!(count>0)) return alert('ุฃุฏุฎู ุนุฏุฏ ุงูุญุจุงุช');
      totalUSD = count * it.price;
    }
    goToCalc(totalUSD, 1, rate.pct); return;
  }

  if (_pendingKind === 'dz'){
    const mode = (document.getElementById('dzMode')||{}).value || 'carton';
    if (mode==='carton'){
      const cartons = num('dzCartons') || 0;
      const per     = num('dzPerCarton') || 0;
      if (!(cartons>0 && per>0)) return alert('ุฃุฏุฎู ุนุฏุฏ ุงููุฑุงุชูู ูุงูุฏูุฒูู/ูุฑุชูู');
      const dozens = cartons * per;
      totalUSD = dozens * it.price;
    } else {
      const pieces = num('dzPieces') || 0;
      if (!(pieces>0)) return alert('ุฃุฏุฎู ุนุฏุฏ ุงูุญุจุงุช');
      const pricePerPiece = it.price / 12;
      totalUSD = pieces * pricePerPiece;
    }
    goToCalc(totalUSD, 1, rate.pct); return;
  }

  if (_pendingKind === 'yd'){
    const rolls = num('rolls') || 0;
    const ydPer = num('ydPerRoll') || 0;
    if (!(rolls>0 && ydPer>0)) return alert('ุฃุฏุฎู ุนุฏุฏ ุงูููุงุช ูุงููุงุฑุฏ/ููุฉ');
    const totalYd = rolls * ydPer;
    totalUSD = totalYd * it.price;
    goToCalc(totalUSD, 1, rate.pct); return;
  }

  if (_pendingKind === 'roll'){
    const mode = (document.getElementById('rollMode')||{}).value || 'carton';
    if (mode==='carton'){
      const rolls = num('rollsInCarton') || 0;
      if (!(rolls>0)) return alert('ุฃุฏุฎู ุนุฏุฏ ุงูููุงุช ูู ุงูุทุฑุฏ');
      totalUSD = rolls * it.price;
    } else {
      const count = num('rollCount') || 0;
      if (!(count>0)) return alert('ุฃุฏุฎู ุนุฏุฏ ุงูููุงุช');
      totalUSD = count * it.price;
    }
    goToCalc(totalUSD, 1, rate.pct); return;
  }

  if (_pendingKind === 'kg'){
    const mode = (document.getElementById('kgMode')||{}).value || 'carton';
    if (mode==='carton'){
      const cartons = num('kgCartons') || 0;
      const per     = num('kgPerCarton') || 0;
      if (!(cartons>0 && per>0)) return alert('ุฃุฏุฎู ุนุฏุฏ ุงููุฑุงุชูู ููุฌู/ูุฑุชูู');
      const totalKg = cartons * per;
      totalUSD = totalKg * it.price;
    } else {
      const totalKg = num('kgTotal') || 0;
      if (!(totalKg>0)) return alert('ุฃุฏุฎู ุฅุฌูุงูู ุงูููููุงุช');
      totalUSD = totalKg * it.price;
    }
    goToCalc(totalUSD, 1, rate.pct); return;
  }

  // ูุญุฏุงุช ุงุณูุงูุฑูุฉ: Ah / W / kW / kVA / L
  if (_pendingKind === 'ah' || _pendingKind === 'w' || _pendingKind === 'kw' || _pendingKind === 'kva' || _pendingKind === 'ltr'){
    const mode = (document.getElementById('scMode')||{}).value || 'total';
    if (mode==='total'){
      const total = num('scTotalVal') || 0;
      if (!(total>0)) return alert('ุฃุฏุฎู ุงูุฅุฌูุงูู');
      totalUSD = total * it.price; // ุงูุณุนุฑ ูููุญุฏุฉ
    } else {
      const count = num('scCount') || 0;
      const per   = num('scPer') || 0;
      if (!(count>0 && per>0)) return alert('ุฃุฏุฎู ุนุฏุฏ ุงููุทุน ูุงููููุฉ/ูุทุนุฉ');
      const total = count * per;
      totalUSD = total * it.price;
    }
    goToCalc(totalUSD, 1, rate.pct); return;
  }

  // other
  if (_pendingKind === 'other'){
    const qty = num('otherQty') || 0;
    if (!(qty>0)) return alert('ุฃุฏุฎู ุงููููุฉ');
    totalUSD = qty * it.price;
    goToCalc(totalUSD, 1, rate.pct); return;
  }
}

function goToCalc(totalUSD, qty, ratePct){
  closeSmartModal();
  if (!(totalUSD>0)) { alert('ุงููููุฉ ุบูุฑ ุตุญูุญุฉ'); return; }
  const url = `./index.html?price=${encodeURIComponent(totalUSD)}&qty=${qty||1}&ratePct=${ratePct||10}`;
  location.href = url;
}

/* ===== ุงุณุชุฎุฏุงู ุงูุณุนุฑ โ ุงูุญุงุณุจุฉ (ููุชุญ ุงูููุฏุงู ุงูุฐูู) ===== */
window.usePrice = function(idx){
  openForItem(idx);
};

/* ===== ุชุนุฏูู/ุญุฐู ===== */
window.editItem = function(idx){
  if(!isOwner) return alert('ูุฐุง ุงูุฅุฌุฑุงุก ูููุงูู ููุท');
  const it = items[idx]; if(!it) return;
  editIndex = idx;
  fName.value  = it.name;
  fPrice.value = it.price;
  fUnit.value  = it.unit;
  fNotes.value = it.notes || '';
  formRow.scrollIntoView({behavior:'smooth', block:'center'});
};
window.deleteItem = function(idx){
  if(!isOwner) return alert('ูุฐุง ุงูุฅุฌุฑุงุก ูููุงูู ููุท');
  const it = items[idx]; if(!it) return;
  if(confirm(`ุณูุชู ุญุฐู "${it.name}". ูุชุงุจุนุฉุ`)){
    items.splice(idx,1);
    saveLocal(); render();
  }
};

/* ===== ุญูุธ/ุชูุฑูุบ ูุญูู ===== */
saveBtn?.addEventListener('click', ()=>{
  if(!isOwner) return alert('ูุฐุง ุงูุฅุฌุฑุงุก ูููุงูู ููุท');
  const rec = normalize({name:fName.value, price:fPrice.value, unit:fUnit.value, notes:fNotes.value});
  if(!rec.name) return alert('ุงูุชุจ ุงุณู ุงูุณูุนุฉ');
  if(!(rec.price>0)) return alert('ุงูุชุจ ุณุนุฑูุง ุตุญูุญูุง ุจุงูุฏููุงุฑ');

  if(editIndex>=0){ items[editIndex] = rec; editIndex=-1; }
  else{
    const i = items.findIndex(x=>x.name===rec.name);
    if(i>=0) items[i] = rec; else items.push(rec);
  }
  saveLocal(); render();
  fName.value=''; fPrice.value=''; fNotes.value='';
});
clearBtn?.addEventListener('click', ()=>{ editIndex=-1; fName.value=''; fPrice.value=''; fNotes.value=''; });

/* ===== ุจุญุซ/ุงุณุชูุฑุงุฏ/ุชุตุฏูุฑ (ูุญูู) ===== */
let ts=null;
q.addEventListener('input', ()=>{
  clearTimeout(ts);
  ts=setTimeout(()=>{
    render();
    try{ window.trackSearch && window.trackSearch(q.value); }catch(_){}
  }, 400);
});
q.addEventListener('keydown', (e)=>{ if(e.key === 'Enter'){ e.preventDefault(); } });

exportBtn.addEventListener('click', (e)=>{
  if(!isOwner){
    e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation?.();
    return alert('ูุฐุง ุงูุฅุฌุฑุงุก ูููุงูู ููุท');
  }
  const blob = new Blob([JSON.stringify(items, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = Object.assign(document.createElement('a'), {href:url, download:'prices_export.json'});
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});

importBtn.addEventListener('click', (e)=>{
  if(!isOwner){
    e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation?.();
    return alert('ูุฐุง ุงูุฅุฌุฑุงุก ูููุงูู ููุท');
  }
  importFile.click();
});
importFile.addEventListener('click', (e)=>{
  if(!isOwner){
    e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation?.();
    return false;
  }
}, true);
importFile.addEventListener('change', async (e)=>{
  if(!isOwner){
    e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation?.();
    e.target.value = '';
    return alert('ูุฐุง ุงูุฅุฌุฑุงุก ูููุงูู ููุท');
  }
  const file = e.target.files?.[0]; if(!file) return;
  try{
    const txt = await file.text();
    const arr = JSON.parse(txt);
    if(!Array.isArray(arr)) throw new Error('ุตูุบุฉ ุบูุฑ ุตุญูุญุฉ');
    items = arr.map(normalize);
    saveLocal(); render(); alert('โ ุชู ุงูุงุณุชูุฑุงุฏ ุจูุฌุงุญ');
  }catch(err){ alert('โ ุชุนุฐุฑ ูุฑุงุกุฉ ุงูููู: ' + err.message); }
  importFile.value = '';
});

/* ===== ุญูุธ ุฅูู GitHub ุนุจุฑ /api/update ===== */
async function pushToGitHub(){
  if(!isOwner) return alert('ูุฐุง ุงูุฅุฌุฑุงุก ูููุงูู ููุท');
  if(!ownerPin){ return alert('ุฃุนุฏ ูุชุญ ูุถุน ุงููุงูู ุฃูููุง'); }
  const payload = {
    pin: ownerPin,
    items: items.map(normalize),
    message: (commitMsg.value || '').trim() || 'ุชุญุฏูุซ ูุงุฆูุฉ ุงูุฃุณุนุงุฑ ูู ุฏุงุฎู ุงูุชุทุจูู'
  };
  try{
    const r = await fetch('/api/update', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const data = await r.json().catch(()=>({}));
    if(!r.ok){ throw new Error(data.detail || r.statusText); }
    alert('โ ุชู ุงูุญูุธ ุฅูู GitHub ุจูุฌุงุญ');
  }catch(err){
    alert('โ ูุดู ุงูุญูุธ ุฅูู GitHub: ' + err.message);
  }
}
pushBtn?.addEventListener('click', pushToGitHub);

/* ===== ูุชุญ/ููู ===== */
function updateOwnerUI(){
  state.textContent = 'ุงูุญุงูุฉ: ' + (isOwner ? 'ูุงูู (ุชุญุฑูุฑ ููุนูู)' : 'ูุฑุงุกุฉ ููุท');
  formRow.classList.toggle('owner-only', !isOwner);
  [exportBtn, importBtn, pushBtn, commitMsg].forEach(el=>{
    if(!el) return;
    el.disabled = !isOwner;
    el.classList.toggle('owner-only', !isOwner);
    if(!isOwner){ el.value !== undefined && (el.value=''); }
  });
}
unlock.addEventListener('click', ()=>{
  if(pin.value === ADMIN_PIN){
    isOwner=true; ownerPin=pin.value; updateOwnerUI(); alert('โ ุชู ูุชุญ ูุถุน ุงููุงูู');
  } else alert('โ ุฑูุฒ ุบูุฑ ุตุญูุญ');
});
lockBtn.addEventListener('click', ()=>{ isOwner=false; ownerPin=null; updateOwnerUI(); });

/* ===== ุจุฏุก ุงูุชุดุบูู ===== */
updateOwnerUI();
boot();
</script>

<!-- ุชุชุจููุน ุจุณูุท -->
<script>
(function(){
  const TRACK_URL="https://bassam-tracker.onrender.com/track";
  function uuid(){return'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{
    const r=crypto.getRandomValues(new Uint8Array(1))[0]&15,v=c==='x'?r:(r&3|8);return v.toString(16);
  });}
  const LS=localStorage; let deviceId=LS.getItem("deviceId"); if(!deviceId){deviceId=uuid();LS.setItem("deviceId",deviceId);}
  async function send(event,payload){
    const body=JSON.stringify({event,deviceId,payload:payload||{}}); 
    try{
      if(navigator.sendBeacon){navigator.sendBeacon(TRACK_URL,new Blob([body],{type:"application/json"}));}
      else{await fetch(TRACK_URL,{method:"POST",headers:{"Content-Type":"application/json"},body});}
    }catch(_){}
  }
  document.addEventListener("DOMContentLoaded",()=>send("page_view",{path:location.pathname,title:document.title}));
  window.trackSearch=(q)=>send("search",{q:String(q||"").trim(),page:location.pathname});
})();
</script>
</body>
</html>
