<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ø¹Ø§Ø±</title>
  <meta name="theme-color" content="#16a34a">
  <style>
    :root{--green:#16a34a; --ink:#0f172a; --muted:#64748b; --card:#fff; --bg:#f1f5f9;}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);font-family:'Noto Kufi Arabic',system-ui,sans-serif;color:var(--ink)}
    .wrap{max-width:720px;margin:16px auto;padding:12px}
    .hero{background:linear-gradient(135deg,#16a34a,#22c55e);color:#fff;border-radius:18px;padding:16px}
    .nav{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .nav a{background:#e2e8f0;color:#0f172a;text-decoration:none;padding:8px 12px;border-radius:10px;font-weight:700}
    .card{background:var(--card);border-radius:16px;padding:14px;margin-top:12px;box-shadow:0 6px 18px rgba(0,0,0,.06);border:1px solid #e5e7eb}
    .owner{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{border:none;border-radius:12px;padding:10px 14px;font-weight:800;cursor:pointer}
    .btn-blue{background:#2563eb;color:#fff} .btn-gray{background:#e2e8f0}
    .btn-green{background:#16a34a;color:#fff} .btn-orange{background:#f97316;color:#fff} .btn-red{background:#ef4444;color:#fff}
    input,select,textarea{width:100%;padding:12px;border:1px solid #cbd5e1;border-radius:12px}
    .row{display:grid;grid-template-columns:1fr 120px 120px;gap:8px}
    .search{display:flex;gap:8px}
    .badge{display:inline-block;background:#eef2ff;color:#1e293b;border:1px solid #c7d2fe;padding:4px 8px;border-radius:999px;font-size:12px}
    .item{display:flex;gap:10px;align-items:flex-start;justify-content:space-between;padding:12px;border:1px solid #e5e7eb;border-radius:14px;margin-top:10px}
    .left h3{margin:0 0 6px 0;font-size:18px}
    .hint{color:var(--muted);font-size:12px;margin-top:4px}
    .btns{display:flex;gap:8px;flex-wrap:wrap}
  </style>
</head>
<body>
<div class="wrap">
  <section class="hero">
    <h2 style="margin:0">ğŸ’² Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ø¹Ø§Ø±</h2>
    <div class="nav">
      <a href="./">ğŸ  Ø§Ù„Ø­Ø§Ø³Ø¨Ø©</a>
      <a href="./hs.html">ğŸ” Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø¬Ù…Ø±ÙƒÙŠØ©</a>
    </div>
  </section>

  <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ù…Ø§Ù„Ùƒ -->
  <section class="card">
    <div class="owner">
      <span>ğŸ”’ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø§Ù„Ùƒ:</span>
      <input id="pin" type="password" placeholder="PIN" style="max-width:180px" />
      <button class="btn btn-blue" id="unlock">ÙØªØ­</button>
      <button class="btn btn-gray" id="lock">Ù‚ÙÙ„</button>
      <small id="state">Ø§Ù„Ø­Ø§Ù„Ø©: Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·</small>
    </div>
  </section>

  <!-- Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¥Ø¶Ø§ÙØ©/Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ -->
  <section class="card" id="formCard" style="display:none">
    <h3 style="margin-top:0">Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ Ø³Ø¹Ø± Ø³Ù„Ø¹Ø©</h3>
    <div class="row" style="margin-bottom:8px">
      <input id="fName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø³Ù„Ø¹Ø©â€¦ Ù…Ø«Ø§Ù„: Ù…Ù„Ø§Ø¨Ø³" />
      <input id="fPrice" type="number" inputmode="decimal" placeholder="Ø¨Ø§Ù„Ø¯ÙˆÙ„Ø§Ø±" />
      <select id="fUnit">
        <option value="ton">Ø§Ù„Ø·Ù†</option>
        <option value="kg">Ø§Ù„ÙƒÙŠÙ„Ùˆ</option>
        <option value="dz">Ø§Ù„Ø¯ÙØ²Ù’Ù†</option>
        <option value="pcs">Ø§Ù„Ø­Ø¨Ø©</option>
        <option value="ltr">Ø§Ù„Ù„ØªØ±</option>
        <option value="Ah">Ah/Ø£Ù…Ø¨ÙŠØ±</option>
        <option value="W">W/ÙˆØ§Ø·</option>
        <option value="yd">ÙŠØ§Ø±Ø¯Ø©</option>
      </select>
    </div>
    <textarea id="fNotes" rows="3" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ù…Ø«Ø§Ù„: Ø§Ù„ÙØ¦Ø©5%ØŒ Ù…ØµØ¯Ø± Ø§Ù„Ø³Ø¹Ø±ØŒ ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ­Ø¯ÙŠØ«)â€¦"></textarea>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">
      <button class="btn btn-blue" id="saveBtn">Ø­ÙØ¸/ØªØ­Ø¯ÙŠØ«</button>
      <button class="btn btn-gray" id="clearBtn">ØªÙØ±ÙŠØº Ø§Ù„Ù†Ù…ÙˆØ°Ø¬</button>
    </div>
  </section>

  <!-- Ø¨Ø­Ø« ÙˆØªØµØ¯ÙŠØ±/Ø§Ø³ØªÙŠØ±Ø§Ø¯ -->
  <section class="card">
    <div class="search">
      <input id="q" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…â€¦ Ù…Ø«Ø§Ù„: Ø¨Ø·Ø§Ø±ÙŠØ§ØªØŒ Ø´Ø¨ÙƒØŒ Ù…Ù„Ø§Ø¨Ø³" />
      <button class="btn btn-blue" id="exportBtn">ØªØµØ¯ÙŠØ± JSON</button>
      <button class="btn btn-gray" id="importBtn">Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON</button>
      <input id="importFile" type="file" accept="application/json" style="display:none" />
    </div>
  </section>

  <!-- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© -->
  <section class="card" id="listCard">
    <div id="list"></div>
  </section>
</div>

<script>
/* ===== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø© ===== */
const ADMIN_PIN = "bassam1234";
const LS_KEY = 'pricesCatalogV3';          // ØªØ®Ø²ÙŠÙ† Ù…Ø­Ù„ÙŠ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„/Ø§Ù„Ø­Ø°Ù
const REMOTE_JSON = '/json/prices_catalog.json'; // Ù…Ù„ÙÙƒ Ø§Ù„Ø¹Ø§Ù… (Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†)

const state = document.getElementById('state');
const pin   = document.getElementById('pin');
const unlock= document.getElementById('unlock');
const lock  = document.getElementById('lock');
const formCard = document.getElementById('formCard');

const fName  = document.getElementById('fName');
const fPrice = document.getElementById('fPrice');
const fUnit  = document.getElementById('fUnit');
const fNotes = document.getElementById('fNotes');
const saveBtn= document.getElementById('saveBtn');
const clearBtn= document.getElementById('clearBtn');

const q = document.getElementById('q');
const list = document.getElementById('list');
const exportBtn = document.getElementById('exportBtn');
const importBtn = document.getElementById('importBtn');
const importFile= document.getElementById('importFile');

let isOwner = false;
let catalog = [];     // Ø§Ù„Ù…ØµØ¯Ø± Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶
let editIndex = -1;   // -1 = Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯Ø©

/* ===== Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© ===== */
const unitLabel = (u)=>({
  ton:'Ø§Ù„Ø·Ù†', kg:'Ø§Ù„ÙƒÙŠÙ„Ùˆ', dz:'Ø§Ù„Ø¯ÙØ²Ù’Ù†', pcs:'Ø§Ù„Ø­Ø¨Ø©', ltr:'Ø§Ù„Ù„ØªØ±', Ah:'Ah/Ø£Ù…Ø¨ÙŠØ±', W:'W/ÙˆØ§Ø·', yd:'ÙŠØ§Ø±Ø¯Ø©'
}[u] || u || '');

function enfmt(n){ return new Intl.NumberFormat('en-US').format(n); }

/* Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ÙØ¦Ø© Ù…Ù† Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ÙŠØ±Ø¬Ø¹ 0.2075 (ÙØ¦Ø© 5%) Ø£Ùˆ 0.265 (ÙØ¦Ø© 10%) Ø£Ùˆ null */
function parseRateFromNotes(notes=''){
  const t = (notes||'').toString().replace(/\s+/g,'').toLowerCase();
  // Ø§Ø¨Ø­Ø« Ø¹Ù† 5% Ø£Ùˆ Ù¡Ù Ùª Ø¨Ø§Ø®ØªÙ„Ø§Ù Ø§Ù„ØµÙŠØº
  if (/(Ø§Ù„ÙØ¦Ù‡|Ø§Ù„ÙØ¦Ø©)?10%|Ù¡Ù %|%10|10Ùª/.test(t)) return 0.265;
  if (/(Ø§Ù„ÙØ¦Ù‡|Ø§Ù„ÙØ¦Ø©)?5%|Ù¥%|%5|5Ùª/.test(t))   return 0.2075;
  return null;
}

/* ===== ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø§Ù„Ùƒ ===== */
function updateOwnerUI(){
  state.textContent = 'Ø§Ù„Ø­Ø§Ù„Ø©: ' + (isOwner ? 'Ù…Ø§Ù„Ùƒ (ØªØ­Ø±ÙŠØ± Ù…ÙØ¹Ù‘Ù„)' : 'Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·');
  formCard.style.display = isOwner ? '' : 'none';
  render();
}
unlock.addEventListener('click', ()=>{
  if(pin.value === ADMIN_PIN){ isOwner=true; updateOwnerUI(); alert('âœ… ØªÙ… ÙØªØ­ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø§Ù„Ùƒ'); }
  else alert('âŒ Ø±Ù…Ø² ØºÙŠØ± ØµØ­ÙŠØ­');
});
lock.addEventListener('click', ()=>{ isOwner=false; updateOwnerUI(); });

/* ===== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ===== */
function loadLocal(){ try{ return JSON.parse(localStorage.getItem(LS_KEY))||null }catch{ return null } }
function saveLocal(arr){ localStorage.setItem(LS_KEY, JSON.stringify(arr)); }

async function loadCatalog(){
  // 1) Ø¬Ø±Ù‘Ø¨ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯ (ÙŠØ­ÙØ¸ ØªØ¹Ø¯ÙŠÙ„Ø§ØªÙƒ)
  const local = loadLocal();
  if (local && Array.isArray(local)) { catalog = local; render(); return; }
  // 2) Ø®Ù„Ø§Ù Ø°Ù„ÙƒØŒ Ø§Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø¹Ø§Ù… Ø«Ù… Ø®Ø²Ù‘Ù†Ù‡ Ù…Ø­Ù„ÙŠØ§Ù‹ Ù„Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø©
  try{
    const res = await fetch(REMOTE_JSON, {cache:'no-store'});
    const data = await res.json();
    if (Array.isArray(data)) { catalog = data; saveLocal(data); render(); }
    else { catalog = []; render(); }
  }catch{
    catalog = []; render();
  }
}

/* ===== Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ===== */
function render(){
  const term = (q.value||'').trim();
  const items = term ? catalog.filter(x => (x.name||'').includes(term)) : catalog;

  list.innerHTML = items.map((x, idx)=>{
    const i = catalog.indexOf(x); // index Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ ÙÙŠ Ø§Ù„ÙƒØ§ØªØ§Ù„ÙˆØ¬
    const notes = x.notes || x.Ù…Ù„Ø­ÙˆØ¸Ø§Øª || '';
    return `
      <div class="item">
        <div class="left" style="flex:1">
          <h3>${x.name||''} ${x.unit?`<span class="badge">${unitLabel(x.unit)}</span>`:''}</h3>
          <div>${x.price!=null?`USD ${x.price}`:''}</div>
          ${notes?`<div class="hint">${notes}</div>`:''}
        </div>
        <div class="btns">
          <button class="btn btn-green" onclick="usePrice(${i})">Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø³Ø¹Ø±</button>
          <button class="btn btn-orange" onclick="editItem(${i})">ØªØ¹Ø¯ÙŠÙ„</button>
          <button class="btn btn-red" onclick="deleteItem(${i})">Ø­Ø°Ù</button>
        </div>
      </div>
    `;
  }).join('') || '<div class="hint">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ±.</div>';
}

/* ===== Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø³Ø¹Ø± => ÙŠÙØªØ­ Ø§Ù„Ø­Ø§Ø³Ø¨Ø© Ø¨Ø§Ù„Ù‚ÙŠÙ…Ø© ÙˆØ§Ù„ÙØ¦Ø© Ù…Ù† Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª ===== */
window.usePrice = function(idx){
  const it = catalog[idx]; if (!it) return;
  const rate = parseRateFromNotes(it.notes || it.Ù…Ù„Ø­ÙˆØ¸Ø§Øª);
  const url = new URL(location.origin + '/');
  url.searchParams.set('price', String(it.price||0));
  if (rate) url.searchParams.set('rate', String(rate));
  // ÙŠÙ…ÙƒÙ†Ùƒ ØªÙ…Ø±ÙŠØ± Ø§Ù„ÙˆØ­Ø¯Ø© Ø£ÙŠØ¶Ø§Ù‹ Ø¥Ù† Ø£Ø±Ø¯Øª Ù„Ø§Ø­Ù‚Ø§Ù‹:
  // url.searchParams.set('unit', it.unit||'');
  location.href = url.toString();
};

/* ===== ØªØ¹Ø¯ÙŠÙ„ ===== */
window.editItem = function(idx){
  if (!isOwner) return alert('Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ù„Ù…Ø§Ù„Ùƒ ÙÙ‚Ø·');
  const it = catalog[idx]; if(!it) return;
  editIndex = idx;
  fName.value  = it.name || '';
  fPrice.value = it.price != null ? it.price : '';
  fUnit.value  = it.unit || 'pcs';
  fNotes.value = it.notes || it.Ù…Ù„Ø­ÙˆØ¸Ø§Øª || '';
  window.scrollTo({top:0, behavior:'smooth'});
};

saveBtn.addEventListener('click', ()=>{
  if (!isOwner) return alert('Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ù„Ù…Ø§Ù„Ùƒ ÙÙ‚Ø·');
  const name  = (fName.value||'').trim();
  const price = parseFloat(fPrice.value||'');
  const unit  = fUnit.value || 'pcs';
  const notes = fNotes.value || '';

  if (!name)  return alert('Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø³Ù„Ø¹Ø©');
  if (!isFinite(price)) return alert('Ø§ÙƒØªØ¨ Ø§Ù„Ø³Ø¹Ø± Ø¨Ø§Ù„Ø¯ÙˆÙ„Ø§Ø±');

  const obj = { name, price, unit, notes };
  if (editIndex >= 0) catalog[editIndex] = obj; // ØªØ­Ø¯ÙŠØ«
  else catalog.unshift(obj);                     // Ø¥Ø¶Ø§ÙØ© ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰

  saveLocal(catalog);
  clearForm();
  render();
});

function clearForm(){
  editIndex = -1;
  fName.value=''; fPrice.value=''; fUnit.value='ton'; fNotes.value='';
}
clearBtn.addEventListener('click', clearForm);

/* ===== Ø­Ø°Ù ===== */
window.deleteItem = function(idx){
  if (!isOwner) return alert('Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ù„Ù…Ø§Ù„Ùƒ ÙÙ‚Ø·');
  const it = catalog[idx]; if(!it) return;
  if (!confirm(`Ø­Ø°Ù "${it.name}" ØŸ`)) return;
  catalog.splice(idx,1);
  saveLocal(catalog);
  render();
};

/* ===== ØªØµØ¯ÙŠØ±/Ø§Ø³ØªÙŠØ±Ø§Ø¯ ===== */
exportBtn.addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(catalog,null,2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'prices_catalog.json';
  a.click();
  URL.revokeObjectURL(a.href);
});
importBtn.addEventListener('click', ()=> importFile.click());
importFile.addEventListener('change', async (e)=>{
  if(!isOwner) return alert('Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ù„Ù…Ø§Ù„Ùƒ ÙÙ‚Ø·');
  const file = e.target.files[0]; if(!file) return;
  try{
    const text = await file.text();
    const data = JSON.parse(text);
    if (!Array.isArray(data)) throw new Error('Invalid JSON');
    catalog = data;
    saveLocal(catalog);
    render();
  }catch(err){
    alert('Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­');
  }finally{
    e.target.value = '';
  }
});

/* ===== Ø£Ø­Ø¯Ø§Ø« ===== */
q.addEventListener('input', render);

/* ===== Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„ ===== */
updateOwnerUI();
loadCatalog();
</script>
</body>
</html>
