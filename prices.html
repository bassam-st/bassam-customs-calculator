<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ø¹Ø§Ø± (USD)</title>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<style>
  body{font-family:'Noto Kufi Arabic',system-ui,sans-serif;background:#f1f5f9;margin:0}
  .top{background:#2563eb;color:#fff;padding:14px 16px;font-weight:800;text-align:center}
  .wrap{max-width:880px;margin:16px auto;padding:0 12px}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.05);padding:14px;margin-top:12px}
  .muted{color:#64748b;font-size:12px}
  input{width:100%;padding:12px;border:1px solid #cbd5e1;border-radius:12px;font-size:16px;background:#fff}
  .item{display:flex;justify-content:space-between;gap:10px;padding:12px;border-bottom:1px dashed #e2e8f0;align-items:center;flex-wrap:wrap}
  .name{font-weight:800}
  .tag{display:inline-block;background:#eef2ff;border:1px solid #c7d2fe;color:#1e3a8a;border-radius:999px;padding:2px 8px;font-size:12px;margin-inline-start:8px}
  .btn{border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
  .btn-green{background:#16a34a;color:#fff}
  .nav a{display:inline-block;text-decoration:none;background:#e2e8f0;color:#0f172a;padding:8px 12px;border-radius:10px}
</style>
</head>
<body>
  <div class="top">ğŸ’² Ø¥Ø¯Ø§Ø±Ø© Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø³Ù„Ø¹ (USD)</div>
  <div class="wrap">
    <div class="nav"><a href="./index.html?v=3">â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø­Ø§Ø³Ø¨Ø©</a></div>

    <div class="card">
      <input id="q" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…â€¦ Ù…Ø«Ø§Ù„: Ø¨Ø·Ø§Ø±ÙŠØ§ØªØŒ Ø´Ø¨ÙƒØŒ Ù…Ù„Ø§Ø¨Ø³" />
      <div class="muted" style="margin-top:6px">Ø§Ù„ÙØ¦Ø© ØªÙÙ‚Ø±Ø£ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù…Ù† Ø§Ù„Ø­Ù‚Ù„ <code>rate</code> (Ø¥Ù† ÙˆÙØ¬Ø¯) Ø£Ùˆ Ù…Ù† Ø§Ù„Ù†Øµ Ø¯Ø§Ø®Ù„ <code>notes</code> (Ù…Ø«Ù„: Ø§Ù„ÙØ¦Ù‡5% Ø£Ùˆ Ù¡Ù Ùª).</div>
    </div>

    <div class="card" id="list">
      <div class="muted">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øªâ€¦</div>
    </div>
  </div>

<script>
  // Ø§ÙƒØ³Ø± Ø§Ù„ÙƒØ§Ø´ Ø¨Ø¥Ø¶Ø§ÙØ© ?v=Ø±Ù‚Ù…
  const FILE_URL = './assets/prices_catalog.json?v=3';

  function normalizeArabicDigits(s=""){
    const map = {'Ù ':'0','Ù¡':'1','Ù¢':'2','Ù£':'3','Ù¤':'4','Ù¥':'5','Ù¦':'6','Ù§':'7','Ù¨':'8','Ù©':'9'};
    return String(s).replace(/[Ù -Ù©]/g, d => map[d]);
  }
  function extractRate(text=""){
    if(!text) return null;
    // Ø£Ù…Ø«Ù„Ø© Ù…Ø¯Ø¹ÙˆÙ…Ø©: "Ø§Ù„ÙØ¦Ù‡5%" ØŒ "Ø§Ù„ÙØ¦Ø© 10 %" ØŒ "5%" ØŒ "Ù¡Ù Ùª"
    const t = normalizeArabicDigits(text).replace(/\s/g,'');
    const m = t.match(/(\d{1,2})\s*%|(\d{1,2})\s*Ùª/);
    if (!m) return null;
    const num = parseInt((m[1]||m[2]),10);
    if (num === 5) return 5;
    if (num === 10) return 10;
    return null;
  }
  function unitLabel(u){
    return u==='ton'?'Ø§Ù„Ø·Ù†':u==='kg'?'Ø§Ù„ÙƒÙŠÙ„Ùˆ':u==='dz'?'Ø§Ù„Ø¯Ø±Ø²Ù†':u==='pcs'?'Ø§Ù„Ø­Ø¨Ø©':u==='Ah'?'Ø§Ù„Ø£Ù…Ø¨ÙŠØ±/Ø³Ø§Ø¹Ø©':u==='W'?'Ø§Ù„ÙˆØ§Øª':u==='ltr'?'Ø§Ù„Ù„ØªØ±':(u||'');
  }

  const q = document.getElementById('q');
  const list = document.getElementById('list');
  let DATA=[];

  function render(items){
    if(!items.length){ list.innerHTML = '<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øªâ€¦</div>'; return; }
    list.innerHTML = items.map(x=>{
      const r1 = extractRate(x.rate);
      const r2 = extractRate(x.notes);
      const rateNum = r1 ?? r2; // Ø§Ù„Ø£Ø³Ø¨Ù‚ÙŠØ© Ù„Ù„Ø­Ù‚Ù„ rate
      const rateTag = rateNum ? `<span class="tag">${rateNum}%</span>` : '';
      return `
        <div class="item">
          <div>
            <div class="name">${x.name||''} ${rateTag}</div>
            <div class="muted">USD ${x.price||0} â€¢ <span class="tag">${unitLabel(x.unit||'')}</span> ${x.notes?('â€¢ '+x.notes):''}</div>
          </div>
          <button class="btn btn-green" onclick='useInCalc(${JSON.stringify(x.name||"")}, ${Number(x.price||0)}, ${JSON.stringify(x.unit||"")}, ${JSON.stringify(x.notes||"")}, ${JSON.stringify(x.rate||"")})'>Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø³Ø¹Ø±</button>
        </div>
      `;
    }).join('');
  }

  function search(text){
    const s = (text||'').trim();
    if(!s) return DATA;
    return DATA.filter(x=> (x.name||'').includes(s));
  }

  window.useInCalc = function(name, price, unit, notes, rateRaw){
    const r1 = extractRate(rateRaw);
    const r2 = extractRate(notes);
    const rateNum = r1 ?? r2; // 5 Ø£Ùˆ 10 Ø£Ùˆ null
    console.log('useInCalc:', {name,price,unit,notes,rateRaw,rateNum});
    const params = new URLSearchParams({
      name, price, unit,
      rate: rateNum ? String(rateNum) : '',
      note: notes||''
    });
    location.href = './index.html?v=3&' + params.toString();
  }

  q.addEventListener('input', ()=>render(search(q.value)));

  (async function init(){
    try{
      const res = await fetch(FILE_URL, {cache: 'no-store'});
      if(!res.ok) throw new Error('HTTP '+res.status);
      DATA = await res.json();
      console.log('Loaded catalog items:', DATA.length);
      render(DATA);
    }catch(e){
      console.error('Catalog load error:', e);
      list.innerHTML = '<div class="muted">ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø£Ø³Ø¹Ø§Ø±. ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ <code>assets/prices_catalog.json</code></div>';
    }
  })();
</script>
</body>
</html>
