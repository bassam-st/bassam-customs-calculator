<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¥Ø¯Ø§Ø±Ø© Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø³Ù„Ø¹ (USD)</title>
<style>
  body{font-family:'Noto Kufi Arabic',system-ui,sans-serif;background:#f1f5f9;margin:0}
  .top{background:#2563eb;color:#fff;padding:14px 16px}
  .wrap{max-width:880px;margin:16px auto;padding:0 12px}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.05);padding:14px;margin-top:12px}
  .row{display:grid;grid-template-columns:1fr 160px 140px;gap:10px}
  label{display:block;font-size:13px;color:#475569;margin-bottom:4px}
  input,select{width:100%;padding:10px;border:1px solid #cbd5e1;border-radius:10px;background:#fff;font-size:14px}
  .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .btn{border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
  .btn-blue{background:#2563eb;color:#fff}
  .btn-green{background:#16a34a;color:#fff}
  .btn-gray{background:#e2e8f0;color:#0f172a}
  .btn-orange{background:#f97316;color:#fff}
  .btn-red{background:#ef4444;color:#fff}
  .list .item{display:flex;justify-content:space-between;gap:10px;padding:10px;border-bottom:1px dashed #cbd5e1;align-items:center;flex-wrap:wrap}
  .muted{color:#64748b;font-size:12px}
  .tag{display:inline-block;background:#eef2ff;color:#1e3a8a;border:1px solid #c7d2fe;padding:2px 8px;border-radius:999px;font-size:12px;margin-inline-start:6px}
  .nav{margin:10px 0}
  .nav a{display:inline-block;margin-left:8px;text-decoration:none;background:#e2e8f0;color:#0f172a;padding:8px 12px;border-radius:10px}
  @media(max-width:640px){.row{grid-template-columns:1fr}}
  .owner-bar{display:flex;gap:8px;align-items:center}
  .owner-hint{font-size:12px;color:#475569}
</style>
</head>
<body>
  <div class="top"><b>$ Ø¥Ø¯Ø§Ø±Ø© Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø³Ù„Ø¹ (USD)</b></div>
  <div class="wrap">
    <div class="nav"><a href="./index.html">â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø­Ø§Ø³Ø¨Ø©</a></div>

    <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ù…Ø§Ù„Ùƒ -->
    <div class="card">
      <div class="owner-bar">
        <span>ğŸ”’ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø§Ù„Ùƒ:</span>
        <input id="pin" type="password" placeholder="PIN" />
        <button class="btn btn-blue" id="unlock">ÙØªØ­</button>
        <button class="btn btn-gray" id="lock">Ù‚ÙÙ„</button>
        <span id="ownerState" class="owner-hint">Ø§Ù„Ø­Ø§Ù„Ø©: Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·</span>
      </div>
      <div class="owner-hint">Ø¨Ø¯ÙˆÙ† ÙØªØ­ØŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¥Ø¶Ø§ÙØ©/Ø§Ù„ØªØ¹Ø¯ÙŠÙ„/Ø§Ù„Ø­Ø°Ù Ø£Ùˆ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯/Ø§Ù„ØªØµØ¯ÙŠØ±.</div>
    </div>

    <!-- Ø£Ø¯ÙˆØ§Øª + Ù‚Ø§Ø¦Ù…Ø© -->
    <div class="card">
      <div class="actions">
        <input id="q" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…â€¦ Ù…Ø«Ø§Ù„: Ø´Ø¨ÙƒØŒ Ø¨Ø·Ø§Ø·Ø³ØŒ Ø¨Ø·Ø§Ø±ÙŠØ§Øª" />
        <button class="btn btn-blue" id="exportBtn" disabled>ØªØµØ¯ÙŠØ± JSON</button>
        <button class="btn btn-gray" id="importBtn" disabled>Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON</button>
        <input type="file" id="importFile" accept="application/json" style="display:none" />
      </div>
      <div class="list" id="list" style="margin-top:8px"></div>
    </div>
  </div>

<script src="./main.js"></script>
<script>
const KEY='pricesCatalogV2';
const q=document.getElementById('q');
const list=document.getElementById('list');
const exportBtn=document.getElementById('exportBtn');
const importBtn=document.getElementById('importBtn');
const importFile=document.getElementById('importFile');

let baseData=[];
async function loadBase(){
  try{ baseData = await fetch('./assets/prices_catalog.json?ts='+Date.now()).then(r=>r.json()); }
  catch{ baseData=[]; }
}
function loadLocal(){ try{ return JSON.parse(localStorage.getItem(KEY))||[] }catch{ return [] } }
function saveLocal(arr){ localStorage.setItem(KEY, JSON.stringify(arr)); }
function merged(){
  const m=new Map();
  baseData.forEach(x=> m.set((x.name||'').trim(), x));
  loadLocal().forEach(x=> m.set((x.name||'').trim(), x));
  return Array.from(m.values());
}

function unitLabel(u){ return u==='ton'?'Ù„Ù„Ø·Ù†':u==='kg'?'Ù„Ù„ÙƒÙŠÙ„Ùˆ':u==='dz'?'Ù„Ù„Ø¯ÙØ²Ù’Ù†':u==='pcs'?'Ù„Ù„Ø­Ø¨Ø©':u==='Ah'?'Ah/Ø£Ù…Ø¨ÙŠØ±':u==='W'?'W/ÙˆØ§Ø·':u==='ltr'?'Ù„Ù„ØªØ±':u; }

// ÙŠØ¹Ø±Ø¶ Ø§Ù„Ø¹Ù†Ø§ØµØ± ÙˆÙŠÙÙ…Ø±Ù‘Ø± Ø§Ù„ÙØ¦Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©
function render(){
  const arr=merged();
  const s=(q.value||'').trim();
  const filtered = s ? arr.filter(x=> (x.name||'').includes(s)) : arr;
  if(!filtered.length){ list.innerHTML='<div class="muted" style="padding:10px">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øªâ€¦</div>'; return; }

  list.innerHTML = filtered.map(x=>{
    const normRate = normalizeRate(x.rate);         // 0.05 Ø£Ùˆ 0.10
    const badge    = prettyRate(x.rate);            // "5%" Ø£Ùˆ "10%"
    const nameQ = JSON.stringify(x.name||'');
    const unitQ = x.unit||'';
    const priceQ= Number(x.price||0);

    return `<div class="item">
      <div>
        <div><b>${x.name||''}</b>
             <span class="tag">${unitLabel(unitQ||'')}</span>
             <span class="tag">${badge}</span></div>
        <div class="muted">USD ${priceQ}${x.notes?(' â€¢ '+x.notes):''}</div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn btn-green"
          onclick="useInCalc(${nameQ}, ${priceQ}, '${unitQ}', '${badge}')">Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø³Ø¹Ø±</button>
      </div>
    </div>`;
  }).join('');
}

// ÙŠØ°Ù‡Ø¨ Ù„Ù„Ø­Ø§Ø³Ø¨Ø© Ù…Ø¹ Ø§Ù„ÙØ¦Ø© Ø§Ù„Ù…Ø­Ø³Ù‘Ù†Ø©
window.useInCalc = function(name, price, unit, rateBadge){
  const r = normalizeRate(rateBadge);  // 0.05 / 0.10
  const params = new URLSearchParams({
    name, price, unit,
    qty: '1',
    rate: String(r)
  });
  location.href = './index.html?' + params.toString();
}

// Ø§Ø³ØªÙŠØ±Ø§Ø¯/ØªØµØ¯ÙŠØ±
exportBtn.addEventListener('click', ()=>{
  if(!window.__isOwner) return alert('Ù„Ù„Ù…Ø§Ù„Ùƒ ÙÙ‚Ø·');
  const data = JSON.stringify(merged(), null, 2);
  const blob = new Blob([data], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = Object.assign(document.createElement('a'), {href:url, download:'prices_catalog.json'});
  document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url),500);
});

importBtn.addEventListener('click', ()=>{ if(!window.__isOwner) return alert('Ù„Ù„Ù…Ø§Ù„Ùƒ ÙÙ‚Ø·'); importFile.click(); });
importFile.addEventListener('change', async ()=>{
  if(!window.__isOwner) return;
  const f=importFile.files[0]; if(!f) return;
  try{
    const text=await f.text(); const arr=JSON.parse(text);
    const cleaned=arr.filter(x=>x&&typeof x==='object').map(x=>({
      name:String(x.name||'').trim(),
      price:Number(x.price||0),
      unit:x.unit||'pcs',
      rate: prettyRate(x.rate), // Ù†Ø®Ø²Ù†Ù‡Ø§ Ø¨Ø´ÙƒÙ„ Ù…ØªÙ‘Ø³Ù‚ "5%" / "10%"
      notes:String(x.notes||'').trim()
    })).filter(x=>x.name && x.price>0);
    saveLocal(cleaned); render(); alert('ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯: '+cleaned.length+' Ø¹Ù†ØµØ±');
  }catch(e){ alert('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯: '+e.message); }
  finally{ importFile.value=''; }
});

q.addEventListener('input', render);

(async function init(){
  await loadBase();
  render();
})();
</script>
</body>
</html>
